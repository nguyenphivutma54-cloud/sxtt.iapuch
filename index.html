<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>test_6 - NPV≈® TEST S·∫¶U RI√äNG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; padding: 16px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f5; }
    .stats-panel { position: relative; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); max-width: 420px; border: 1px solid #e6e9ee; }
    .stats-panel-header { display: flex; justify-content: space-between; align-items: center; background: #27ae60; color: #fff; padding: 8px 10px; border-radius: 8px 8px 0 0; }
    .stats-panel-header h4 { margin: 0; font-size: 14px; font-weight: 700; }
    .stats-panel-controls .minimize-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; }
    .stats-panel-content { padding: 10px; }
  </style>
</head>
<body>

  

  <script>
    function toggleStatsPanel(){
      var content = document.querySelector('.stats-panel-content');
      if (!content) return;
      var isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
    }
    function toggleWorkerDetails(){
      var el = document.getElementById('workerDetails');
      var tg = document.getElementById('workerToggle');
      if (!el) return;
      var isHidden = el.style.display === 'none';
      el.style.display = isHidden ? 'block' : 'none';
      if (tg) tg.textContent = isHidden ? '‚ñº' : '‚ñ≤';
    }
    function exportReport(){
      try {
        const filtered = (typeof getFilteredData === 'function') ? getFilteredData() : (window.allTreeData || []);
        if (!filtered || filtered.length === 0) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'); return; }

        // T√≠nh th·ªëng k√™
        const byType = {}; const byQuality = {}; const byDisease = {}; const byFarm = {}; const byTeam = {}; const byLot = {}; const byWorker = {};
        filtered.forEach(r => {
          const type = (r.ten||'').toString();
          const q = (r.chatLuong||r.chat_luong||'').toString();
          const dis = (r.tinhtrangbenh||'').toString();
          const farm=(r.tennt||'').toString(); const team=(r.tendoi||'').toString(); const lot=(r.tenlo||'').toString(); const worker=(r.cn||'').toString();
          if (type) byType[type]=(byType[type]||0)+1;
          if (q) byQuality[q]=(byQuality[q]||0)+1;
          if (dis) byDisease[dis]=(byDisease[dis]||0)+1;
          if (farm) byFarm[farm]=(byFarm[farm]||0)+1;
          if (team) byTeam[team]=(byTeam[team]||0)+1;
          if (lot) byLot[lot]=(byLot[lot]||0)+1;
          if (worker) byWorker[worker]=(byWorker[worker]||0)+1;
        });

        // T·∫°o workbook Excel
        if (typeof XLSX === 'undefined') { alert('Thi·∫øu th∆∞ vi·ªán XLSX'); return; }
        const wb = XLSX.utils.book_new();

        function sheetFromObjectCounter(title, obj){
          const entries = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
          const aoa = [["T√™n", "S·ªë l∆∞·ª£ng", "ƒê∆°n v·ªã"]];
          if (entries.length === 0) {
            aoa.push(["(tr·ªëng)", 0, "c√¢y"]);
          } else {
            entries.forEach(([k,v])=> aoa.push([k, Number(v)||0, "c√¢y"]));
          }
          const ws = XLSX.utils.aoa_to_sheet(aoa);
          XLSX.utils.book_append_sheet(wb, ws, title);
        }

        // 1. Lo·∫°i c√¢y
        sheetFromObjectCounter('LoaiCay', byType);
        // 2. T·ªïng s·ªë c√¢y
        const wsTotal = XLSX.utils.aoa_to_sheet([["Ch·ªâ ti√™u", "Gi√° tr·ªã", "ƒê∆°n v·ªã"],["T·ªïng s·ªë c√¢y", Number(filtered.length)||0, "c√¢y"]]);
        XLSX.utils.book_append_sheet(wb, wsTotal, 'Tong');
        // 3. Ch·∫•t l∆∞·ª£ng c√¢y
        sheetFromObjectCounter('ChatLuong', byQuality);
        // 4. D·ªãch b·ªánh
        sheetFromObjectCounter('DichBenh', byDisease);
        // 5. Thong tin quan ly
        sheetFromObjectCounter('NongTruong', byFarm);
        sheetFromObjectCounter('Doi', byTeam);
        sheetFromObjectCounter('Lo', byLot);
        sheetFromObjectCounter('CongNhan', byWorker);

        // 6. Th√™m sheet Bi·ªÉu ƒë·ªì (Chart data) ƒë·ªÉ ng∆∞·ªùi d√πng m·ªü Excel l√† c√≥ s·∫µn ngu·ªìn v·∫Ω
        const chartAoa = [["Sheet","T√™n","Gi√° tr·ªã"]];
        Object.entries(byType).forEach(([k,v])=> chartAoa.push(["LoaiCay", k, Number(v)||0]));
        chartAoa.push(["","",""]);
        Object.entries(byQuality).forEach(([k,v])=> chartAoa.push(["ChatLuong", k, Number(v)||0]));
        chartAoa.push(["","",""]);
        Object.entries(byDisease).forEach(([k,v])=> chartAoa.push(["DichBenh", k, Number(v)||0]));
        const wsChart = XLSX.utils.aoa_to_sheet(chartAoa);
        XLSX.utils.book_append_sheet(wb, wsChart, 'ChartData');

        // L∆∞u file
        XLSX.writeFile(wb, 'BaoCao_ThongKe.xlsx');
      } catch(err) {
        console.error(err);
        alert('Xu·∫•t b√°o c√°o l·ªói: '+ err.message);
      }
    }
  </script>

</script>
<script>
// Thi·∫øt l·∫≠p link OneDrive m·∫∑c ƒë·ªãnh v√† t·ª± ƒë·ªông load khi m·ªü web
const defaultOneDriveUrl = 'https://1drv.ms/x/c/b1a405a8fc2fd19c/EYnZYK5AtshMi9MmYrcwhv0BRt3QX6E1VaITc1by9ay2ig?download=1';
if (!localStorage.getItem('googleSheetUrl')) {
  localStorage.setItem('googleSheetUrl', defaultOneDriveUrl);
}
window.addEventListener('DOMContentLoaded', function() {
  if (typeof loadFromGoogleSheet === 'function') {
    loadFromGoogleSheet();
    console.log('T·ª± ƒë·ªông load d·ªØ li·ªáu t·ª´ OneDrive khi m·ªü web:', defaultOneDriveUrl);
  }
});
// T·ª± ƒë·ªông reload d·ªØ li·ªáu t·ª´ OneDrive m·ªói 5 ph√∫t
setInterval(function() {
  const url = localStorage.getItem('googleSheetUrl');
  if (url) {
    if (typeof loadFromGoogleSheet === 'function') {
      loadFromGoogleSheet();
      console.log('ƒê√£ t·ª± ƒë·ªông reload d·ªØ li·ªáu t·ª´ OneDrive:', url);
    }
  }
}, 5 * 60 * 1000); // 5 ph√∫t
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Qu·∫£n l√Ω c√¢y tr·ªìng - VN2000</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 100vh; width: 100%; }
    
    .control-panel {
      position: fixed; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.95);
      padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000; max-width: 224px; backdrop-filter: blur(10px);
      resize: both; min-width: 140px; min-height: 150px; overflow: visible;
    }
    
    .control-panel-header {
      background: #3498db; color: white; padding: 6px 10px; margin: -10px -10px 8px -10px;
      border-radius: 8px 8px 0 0; cursor: move; user-select: none;
      display: flex; justify-content: space-between; align-items: center;
    }
    
    .control-panel-header h3 { margin: 0; font-size: 12px; font-weight: 600; }
    
    .control-panel-controls {
      display: flex; gap: 4px;
    }
    
    .control-panel-btn {
      width: 18px; height: 18px; border: none; border-radius: 3px; cursor: pointer;
      font-size: 10px; display: flex; align-items: center; justify-content: center;
    }
    
    .minimize-btn { background: #f39c12; color: white; }
    .close-btn { background: #e74c3c; color: white; }
    
    .control-group {
      margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #eee;
    }
    
    .control-group:last-child { border-bottom: none; margin-bottom: 0; }
    
    .control-group h4 {
      margin: 0 0 4px 0; color: #2c3e50; font-size: 11px; font-weight: 600;
      cursor: pointer; user-select: none;
    }
    
    .control-group h4:after {
      content: ' ‚ñº'; font-size: 8px; float: right;
    }
    
    .control-group h4.collapsed:after {
      content: ' ‚ñ∂';
    }
    
    .control-group-content {
      max-height: none; overflow: visible; 
      transition: max-height 0.3s ease-out; padding-right: 0;
    }
    
    .control-group-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }
    
    /* C·∫£i thi·ªán control panel content */
    .control-panel-content {
      max-height: none; overflow: visible; 
      transition: max-height 0.3s ease-out; padding-right: 0;
    }
    
    .control-panel-content.collapsed {
      max-height: 0;
    }
    
    
    input, select, button {
      width: 100%; padding: 4px 6px; margin: 2px 0; border: 1px solid #ddd;
      border-radius: 4px; font-size: 10px; box-sizing: border-box;
    }
    
    button { background: #3498db; color: white; border: none; cursor: pointer; }
    button:hover { background: #2980b9; }
    button.danger { background: #e74c3c; }
    button.success { background: #27ae60; }
    button.active { background: #e74c3c; animation: pulse 1.5s infinite; }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    
    .legend {
      position: fixed; bottom: 20px; right: 20px; background: rgba(255, 255, 255, 0.95);
      padding: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000; backdrop-filter: blur(10px); max-width: 250px;
      resize: both; min-width: 200px; min-height: 80px;
      font-family: 'Cambria', 'Times New Roman', serif;
    }
    
    .legend-header {
      background: #27ae60;
      color: white;
      padding: 8px 12px;
      margin: -12px -12px 8px -12px;
      border-radius: 8px 8px 0 0;
      cursor: move;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .legend-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    
    .legend-controls {
      display: flex;
      gap: 4px;
    }
    
    .legend-controls button {
      width: 18px;
      height: 18px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
    }
    
    .legend-content {
      font-size: 12px;
      line-height: 1.4;
    }
    
    /* B·∫£ng th√¥ng tin chi ti·∫øt (removed) */
    .detail-table-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      z-index: 2000;
      backdrop-filter: blur(15px);
      min-width: 600px;
      max-width: 90vw;
      max-height: 80vh;
      display: none;
      resize: both;
      overflow: hidden;
      border: 2px solid #3498db;
    }
    
    /* .detail-table-header removed */
    
    /* .detail-table-header h4 removed */
    
    /* .detail-table-controls removed */
    
    /* .detail-table-controls button removed */
    
    /* .detail-table-content removed */
    
    /* .detail-table removed */
    
    /* .detail-table th removed */
    
    /* .detail-table td removed */
    
    /* .detail-table tbody tr:hover removed */
    
    /* .detail-table tbody tr:nth-child(even) removed */
    
    /* .detail-table tbody tr:nth-child(even):hover removed */
    
    /* .detail-table-info removed */
    
    /* .detail-table-empty removed */
    
    /* .detail-table-empty i removed */
    
    .filter-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    
    .filter-info h5 {
      margin: 0 0 4px 0;
      color: #495057;
      font-size: 11px;
      font-weight: 600;
    }
    
    .filter-item {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
      padding: 1px 0;
    }
    
    .filter-label {
      font-weight: 600;
      color: #495057;
    }
    
    .filter-value {
      font-weight: 700;
      color: #27ae60;
    }

    /* Summary panel removed */
    
    .legend-item { display: flex; align-items: center; margin: 4px 0; }
    .legend-color { width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 1px solid #333; }
    .legend-item span { font-size: 11px; }
    
    .status-bar {
      position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.8);
      color: white; padding: 4px 8px; font-size: 8px; z-index: 1000;
    }
    
    /* B·∫£ng th·ªëng k√™ theo b·ªô l·ªçc */
    .filter-stats-panel {
      position: fixed; top: 80px; right: 20px; z-index: 1201;
      background: rgba(255,255,255,0.95); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 10px; min-width: 360px; max-height: 80vh; overflow: auto; backdrop-filter: blur(10px);
    }
    .filter-stats-panel h4 { margin: 0 0 8px 0; font-size: 14px; color: #2c3e50; }
    .filter-stats-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .filter-stats-table th, .filter-stats-table td { padding: 6px 8px; border-bottom: 1px solid #e9ecef; text-align: left; }
    .filter-stats-table th { background: #f8f9fa; color: #2c3e50; }
    
    /* ===== CSS CHO POPUP M·ªöI ===== */
    .tree-popup {
      min-width: 220px;
      max-width: 300px; /* gi·∫£m chi·ªÅu r·ªông */
      max-height: 380px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 13px; /* tƒÉng c·ª° ch·ªØ t·ªïng th·ªÉ */
      line-height: 1.25; /* gi·∫£m gi√£n d√≤ng */
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .popup-header {
      background: #f8f9fa;
      padding: 6px 10px;
      border-radius: 4px 4px 0 0;
      border-left: 4px solid #3498db;
      margin-bottom: 4px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    
    .popup-header:hover {
      background: #e9ecef;
    }
    
    .popup-header.collapsed::after {
      content: " ‚ñº";
      float: right;
      font-size: 10px;
    }
    
    .popup-header.expanded::after {
      content: " ‚ñ≤";
      float: right;
      font-size: 10px;
    }
    
    .popup-content.collapsed {
      display: none;
    }
    
    .popup-actions.collapsed {
      display: none;
    }
    
    .popup-header.success {
      border-left-color: #27ae60;
      background: #d4edda;
    }
    
    .popup-header.edit-mode {
      border-left-color: #e67e22;
      background: #fff3cd;
    }
    
    .popup-header h4 {
      margin: 0;
      color: #2c3e50;
      font-size: 14px; /* tƒÉng nh·∫π ti√™u ƒë·ªÅ */
      font-weight: bold;
    }
    
    .saved-indicator {
      color: #27ae60;
      font-size: 10px;
      font-weight: normal;
    }
    
    .popup-content {
      padding: 0 4px;
      overflow-y: auto;
      flex: 1;
      max-height: 280px; /* gi·∫£m chi·ªÅu cao n·ªôi dung */
    }
    
    .popup-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .popup-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .popup-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }
    
    .popup-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    .info-grid, .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin-bottom: 6px;
    }
    
    .info-group, .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .info-group label, .form-group label {
      font-weight: bold;
      margin-bottom: 1px;
      font-size: 9px;
      color: #2c3e50;
    }
    
    .info-value {
      padding: 2px 4px;
      background: #f8f9fa;
      border-radius: 2px;
      font-size: 12px; /* tƒÉng c·ª° ch·ªØ gi√° tr·ªã */
      color: #2c3e50;
      min-height: 16px;
    }
    
    .quality-t·ªët { color: #27ae60; font-weight: bold; }
    .quality-trung-b√¨nh { color: #f39c12; font-weight: bold; }
    .quality-k√©m { color: #e74c3c; font-weight: bold; }
    .quality-unknown { color: #95a5a6; }
    
    .form-group input, .form-group select {
      padding: 2px 4px;
      border: 1px solid #ddd;
      border-radius: 2px;
      font-size: 9px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 3px rgba(52, 152, 219, 0.3);
    }
    
    .management-section {
      margin: 4px 0;
      padding: 4px;
      background: #f8f9fa;
      border-radius: 3px;
      border-left: 2px solid #27ae60;
    }
    
    .management-section h5 {
      margin: 0 0 3px 0;
      color: #27ae60;
      font-size: 9px;
    }
    
    .management-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
    }
    
    .management-grid .form-group.full-width,
    .management-grid .info-group.full-width {
      grid-column: 1 / -1;
    }
    
    .popup-actions {
      margin-top: 6px;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      padding: 4px 0;
    }
    
    .popup-actions button {
      padding: 4px 8px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 9px;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .btn-save {
      background: #27ae60;
      color: white;
    }
    
    .btn-save:hover {
      background: #229954;
    }
    
    .btn-edit {
      background: #e67e22;
      color: white;
    }
    
    .btn-edit:hover {
      background: #d35400;
    }
    
    .btn-cancel {
      background: #95a5a6;
      color: white;
    }
    
    .btn-cancel:hover {
      background: #7f8c8d;
    }
    .filter-stats-section { margin-bottom: 10px; }
    
    
    .edit-modal {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 12px 14px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 2000; min-width: 280px; width: 360px; max-width: 90vw; max-height: 70vh; overflow: auto;
    }
    
    .edit-modal h3 { margin: 0 0 15px 0; color: #2c3e50; }
    .edit-modal label { display: block; margin: 10px 0 5px 0; font-weight: 600; color: #34495e; }
    .edit-modal .button-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; position: sticky; bottom: 0; background: #fff; padding-top: 10px; border-top: 1px solid #e9ecef; }
    .edit-modal button { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
    .edit-modal .save-btn { background: #27ae60; color: white; }
    .edit-modal .cancel-btn { background: #95a5a6; color: white; }
    .edit-modal .export-btn { background: #3498db; color: white; }
    
    /* CSS cho th∆∞·ªõc ƒëo kho·∫£ng c√°ch */
    .distance-line {
      stroke: #ff0000;
      stroke-width: 3;
      stroke-dasharray: 5, 5;
      fill: none;
    }
    
    .distance-marker {
      background: #ff0000;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .distance-point {
      fill: #ff0000;
      stroke: white;
      stroke-width: 2;
      r: 6;
    }
    
    .distance-total {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 4px 8px; /* nh·ªè h∆°n */
      border-radius: 6px;
      font-size: 11px; /* nh·ªè h∆°n */
      font-weight: 600;
      border: 2px solid #ff0000; /* m·∫£nh h∆°n */
      box-shadow: 0 3px 6px rgba(0,0,0,0.35);
      text-align: center;
      white-space: nowrap;
      display: inline-block; /* v·ª´a kh√≠t ch·ªØ */
    }
    
    /* CSS cho panel b·∫£n ƒë·ªì n·∫±m ngang */
    .map-panel-horizontal {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      backdrop-filter: blur(10px);
      resize: both;
      min-width: 200px;
      min-height: 40px;
    }
    
    .map-panel-header {
      background: #e74c3c;
      color: white;
      padding: 6px 8px;
      margin: -8px -8px 6px -8px;
      border-radius: 8px 8px 0 0;
      cursor: move;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .map-panel-header h4 {
      margin: 0;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    
    .map-panel-controls {
      display: flex;
      gap: 3px;
    }
    
    .map-panel-controls button {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
    }
    
    .map-panel-content {
      max-height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      transition: max-height 0.3s ease-out;
      padding-right: 3px;
    }
    
    .map-panel-content.collapsed {
      max-height: 0;
    }
    
    .map-tool-horizontal {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .map-tool-btn-small {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      width: 28px;
      height: 28px;
    }
    
    .map-tool-btn-small:hover {
      background: #e9ecef;
      border-color: #3498db;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .map-tool-btn-small.active {
      background: #e74c3c;
      color: white;
      border-color: #c0392b;
      animation: pulse 1.5s infinite;
    }
    
    /* Custom scrollbar cho map panel */
    .map-panel-content::-webkit-scrollbar {
      width: 4px;
    }
    
    .map-panel-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }
    
    .map-panel-content::-webkit-scrollbar-thumb {
      background: #bdc3c7;
      border-radius: 2px;
    }
    
    .map-panel-content::-webkit-scrollbar-thumb:hover {
      background: #95a5a6;
    }
    
    /* CSS cho panel th·ªëng k√™ d·ªØ li·ªáu */
    .stats-panel {
      position: fixed;
      top: 90px; /* k√©o xu·ªëng th√™m 20px */
      right: 10px; /* ƒë·∫∑t panel ·ªü g√≥c ph·∫£i nh∆∞ h√¨nh */
      left: auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1201;
      backdrop-filter: blur(10px);
      resize: both;
      min-width: 280px;
      min-height: 60px;
    }
    
    .stats-panel-header {
      background: #27ae60;
      color: white;
      padding: 6px 8px;
      margin: -8px -8px 6px -8px;
      border-radius: 8px 8px 0 0;
      cursor: move;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stats-panel-header h4 {
      margin: 0;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    
    .stats-panel-controls {
      display: flex;
      gap: 3px;
    }
    
    .stats-panel-controls button {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f39c12;
      color: white;
      margin: 0;
      padding: 0;
    }
    
    .stats-panel-controls button:hover {
      background: #e67e22;
    }
    
    .stats-panel-content {
      font-size: 12px;
      line-height: 1.4;
      transition: max-height 0.3s ease-out;
      padding-right: 3px;
      overflow: visible; /* b·ªè cu·ªôn b√™n trong panel th·ªëng k√™ */
    }
    
    .stats-panel-content.collapsed {
      max-height: 0;
    }
    
    /* Custom scrollbar cho stats panel */
    .stats-panel-content::-webkit-scrollbar {
      width: 4px;
    }
    
    .stats-panel-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }
    
    .stats-panel-content::-webkit-scrollbar-thumb {
      background: #bdc3c7;
      border-radius: 2px;
    }
    
    .stats-panel-content::-webkit-scrollbar-thumb:hover {
      background: #95a5a6;
    }

    /* B·ªè cu·ªôn v√† gi·ªõi h·∫°n chi·ªÅu cao trong c√°c v√πng chi ti·∫øt c·ªßa th·ªëng k√™ */
    #treeTypesDetail,
    #diseaseDetails,
    #yearDetails,
    #farmDetails,
    #teamDetails,
    #lotDetails,
    #workerDetails {
      max-height: none !important;
      overflow: visible !important;
    }
    
    /* CSS cho panel th·ªëng k√™ b√™n ph·∫£i - removed */
  </style>
</head>
<body>
  <div class="control-panel">
    <div class="control-panel-header">
      <h3>üéõÔ∏è B·∫£ng ƒëi·ªÅu khi·ªÉn</h3>
      <div class="control-panel-controls">
        <button class="control-panel-btn minimize-btn" onclick="toggleControlPanel()" title="Thu g·ªçn">‚àí</button>
      </div>
    </div>
    <div class="control-panel-content">
      <div class="control-group">
        <h4 onclick="toggleControlGroup(this)">üìÅ D·ªØ li·ªáu</h4>
        <div class="control-group-content">
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="fileInput" accept=".xlsx,.csv" style="flex: 1; min-width: 0;" />
            <button onclick="exportUpdatedData()" class="success" style="white-space: nowrap; padding: 8px 12px; font-size: 12px; width: 80px; flex-shrink: 0;">üíæ Xu·∫•t</button>
          </div>
        </div>
      </div>

      <div class="control-group">
        <h4 onclick="toggleControlGroup(this)">üîó Google Sheets (t·ª± ƒë·ªông)</h4>
        <div class="control-group-content">
          <input type="text" id="googleSheetUrl" placeholder="D√°n li√™n k·∫øt Google Sheets/OneDrive c√¥ng khai (CSV/XLSX)" />
          <div style="display:flex; gap:6px;">
            <button onclick="loadFromGoogleSheet()">‚¨áÔ∏è T·∫£i d·ªØ li·ªáu</button>
            <button onclick="saveGoogleSheetUrl()">üíæ L∆∞u URL</button>
          </div>
          <div style="font-size:10px; color:#6c757d; margin-top:2px;">
            Ch·∫•p nh·∫≠n: ƒë∆∞·ªùng d·∫´n CSV (Publish to web) ho·∫∑c li√™n k·∫øt b·∫£ng t√≠nh d·∫°ng /spreadsheets/d/... (c√¥ng khai). C√≥ th·ªÉ th√™m tham s·ªë gid=...
          </div>
        </div>
      </div>
      
      <div class="control-group">
        <h4 onclick="toggleControlGroup(this)">üîç T√¨m ki·∫øm ID</h4>
        <div class="control-group-content">
          <input type="text" id="searchBox" placeholder="üîç Nh·∫≠p ID c√¢y..." onchange="searchById()" onkeyup="searchById()" />
          <button onclick="clearSearch()" class="danger">üóëÔ∏è X√≥a t√¨m ki·∫øm</button>
        </div>
      </div>
      
      <div class="control-group">
        <h4 onclick="toggleControlGroup(this)">üîΩ L·ªçc d·ªØ li·ªáu</h4>
        <div class="control-group-content">
          <select id="statusFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ ch·∫•t l∆∞·ª£ng</option>
          </select>
          <select id="typeFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ lo·∫°i c√¢y</option>
          </select>
          <select id="yearFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ nƒÉm tr·ªìng</option>
          </select>
          <select id="tenntFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ n√¥ng tr∆∞·ªùng</option>
          </select>
          <select id="tendoiFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ ƒë·ªôi</option>
          </select>
          <select id="tendtFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ ƒë·ªôi tr∆∞·ªüng</option>
          </select>
          <select id="tenloFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ l√¥</option>
          </select>
          <select id="tenttFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ t·ªï tr∆∞·ªüng</option>
          </select>
          <select id="cnFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ c√¥ng nh√¢n</option>
          </select>
          <select id="diseaseFilter" onchange="filterMarkers()">
            <option value="">T·∫•t c·∫£ t√¨nh tr·∫°ng b·ªánh</option>
          </select>
          <button onclick="clearFilters()" class="danger">üóëÔ∏è X√≥a l·ªçc</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Panel th·ªëng k√™ d·ªØ li·ªáu ri√™ng bi·ªát -->
  <div class="stats-panel" id="statsPanel">
    <div class="stats-panel-header" onmousedown="startDrag(event, 'statsPanel')">
      <h4>üìä Th·ªëng k√™ d·ªØ li·ªáu</h4>
      <div class="stats-panel-controls">
        <button class="minimize-btn" onclick="toggleStatsPanel()" title="Thu g·ªçn">‚àí</button>
      </div>
    </div>
    <div class="stats-panel-content">
      <div id="dataStats" style="font-size: 9px; line-height: 1.1;">
        <!-- T·ªïng quan -->
        <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 4px; border-left: 2px solid #3498db;">
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 9px;">üìä T·ªïng quan</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 3px;">
            <div><strong>T·ªïng c√¢y:</strong> <span id="totalTrees" style="color: #27ae60; font-weight: bold;">0 c√¢y</span></div>
          </div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px;">üå≥ Theo ch·ªßng lo·∫°i: <span id="treeTypesHeaderTotal" style="font-weight:bold;">0 c√¢y</span></div>
          <div id="treeTypesDetail" style="font-size: 8px; line-height: 1.2; max-height: 60px; overflow-y: auto;"></div>
        </div>

        <!-- Ch·∫•t l∆∞·ª£ng -->
        <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 4px; border-left: 2px solid #27ae60;">
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 9px;">üå± Ch·∫•t l∆∞·ª£ng: <span id="totalQualityTrees" style="color: #2c3e50; font-weight: bold;">0 c√¢y</span></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 3px;">
            <div><strong>T·ªët:</strong> <span id="goodQuality" style="color: #27ae60; font-weight: bold;">0 c√¢y</span></div>
            <div><strong>TB:</strong> <span id="mediumQuality" style="color: #f39c12; font-weight: bold;">0 c√¢y</span></div>
            <div><strong>K√©m:</strong> <span id="poorQuality" style="color: #e74c3c; font-weight: bold;">0 c√¢y</span></div>
          </div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px;">üìä T·ª∑ l·ªá:</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px;">
            <div><strong>T·ªët:</strong> <span id="goodQualityPercent" style="color: #27ae60; font-weight: bold;">0%</span></div>
            <div><strong>TB:</strong> <span id="mediumQualityPercent" style="color: #f39c12; font-weight: bold;">0%</span></div>
            <div><strong>K√©m:</strong> <span id="poorQualityPercent" style="color: #e74c3c; font-weight: bold;">0%</span></div>
        </div>
      </div>
      
        <!-- D·ªãch b·ªánh -->
        <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 4px; border-left: 2px solid #e74c3c;">
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 9px;">ü¶† D·ªãch b·ªánh: <span id="diseaseHeaderTotal" style="font-weight:bold;"></span></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 3px;">
            <div><strong>B·ªánh:</strong> <span id="diseasedTrees" style="color: #e74c3c; font-weight: bold;">0 c√¢y</span></div>
            <div><strong>Kh·ªèe:</strong> <span id="healthyTrees" style="color: #27ae60; font-weight: bold;">0 c√¢y</span></div>
            <div><strong>B·ªánh ph·ªï bi·∫øn:</strong> <span id="commonDisease" style="color: #8e44ad; font-weight: bold;">-</span></div>
            <div><strong>Ch∆∞a r√µ:</strong> <span id="unknownDisease" style="color: #95a5a6; font-weight: bold;">0 c√¢y</span></div>
          </div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px;">ü¶† Theo lo·∫°i b·ªánh: <span id="diseaseTypesHeaderTotal" style="font-weight:bold;">0 c√¢y</span></div>
          <div id="diseaseDetails" style="font-size: 8px; line-height: 1.2; max-height: 60px; overflow-y: auto;"></div>
        </div>

        <!-- NƒÉm tr·ªìng -->
        <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 4px; border-left: 2px solid #8e44ad;">
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 9px;">üìÖ NƒÉm tr·ªìng: <span id="yearHeaderTotal" style="font-weight:bold;">0 c√¢y</span></div>
          <div id="yearDetails" style="font-size: 8px; line-height: 1.2; max-height: 60px; overflow-y: auto;"></div>
        </div>

        <!-- Th√¥ng tin qu·∫£n l√Ω -->
        <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 4px; border-left: 2px solid #f39c12;">
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 9px;">üë• Qu·∫£n l√Ω</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 3px;">
            <div><strong>N√¥ng tr∆∞·ªùng:</strong> <span id="totalFarms" style="color: #27ae60; font-weight: bold;">0</span></div>
            <div><strong>ƒê·ªôi:</strong> <span id="totalTeams" style="color: #3498db; font-weight: bold;">0</span></div>
            <div><strong>L√¥:</strong> <span id="totalLots" style="color: #8e44ad; font-weight: bold;">0</span></div>
            <div><strong>CN:</strong> <span id="totalWorkers" style="color: #e67e22; font-weight: bold;">0</span></div>
          </div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px;">üè¢ N√¥ng tr∆∞·ªùng: <span id="totalFarmTrees" style="color: #27ae60; font-weight: bold;">0 c√¢y</span></div>
          <div id="farmDetails" style="font-size: 8px; line-height: 1.2; max-height: 40px; overflow-y: auto; margin-bottom: 3px;"></div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px;">üë• ƒê·ªôi: <span id="totalTeamTrees" style="color: #3498db; font-weight: bold;">0 c√¢y</span></div>
          <div id="teamDetails" style="font-size: 8px; line-height: 1.2; max-height: 40px; overflow-y: auto; margin-bottom: 3px;"></div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px;">üì¶ L√¥: <span id="totalLotTrees" style="color: #8e44ad; font-weight: bold;">0 c√¢y</span></div>
          <div id="lotDetails" style="font-size: 8px; line-height: 1.2; max-height: 40px; overflow-y: auto; margin-bottom: 3px;"></div>
          <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px; font-size: 8px; cursor: pointer;" onclick="toggleWorkerDetails()">
            üë∑ C√¥ng nh√¢n: <span id="totalWorkerTrees" style="color: #e67e22; font-weight: bold;">0 c√¢y</span>
            <span id="workerToggle" style="float: right; font-size: 7px; color: #95a5a6;">‚ñº</span>
          </div>
          <div id="workerDetails" style="font-size: 8px; line-height: 1.2; max-height: 40px; overflow-y: auto; display: block;"></div>
        </div>

        <button id="openReportBtn" type="button" onclick="openReportModal()" style="margin-top: 4px; padding: 2px 6px; font-size: 8px; background: #27ae60; color: white; border: none; border-radius: 2px; cursor: pointer;">üìä Xem b√°o c√°o</button>
        <button onclick="exportReport()" style="margin-top: 4px; margin-left:6px; padding: 2px 6px; font-size: 8px; background: #3498db; color: white; border: none; border-radius: 2px; cursor: pointer;">‚¨áÔ∏è Xu·∫•t Excel</button>
      </div>
    </div>
  </div>

  <script>
    let reportCharts = {};
    function openReportModal(){
      const modal = document.getElementById('reportModal');
      modal.style.display = 'block';
      const data = (typeof getFilteredData === 'function') ? getFilteredData() : (window.allTreeData || []);
      const setText = (id, text)=>{ const el = document.getElementById(id); if (el) el.textContent = text; };
      const agg = (getter) => data.reduce((m,r)=>{ const k=(getter(r)||'').toString(); if(!k) return m; m[k]=(m[k]||0)+1; return m;},{});
      const byType = agg(r=>r.ten);
      const byQuality = agg(r=>r.chatLuong||r.chat_luong);
      const byDisease = agg(r=>r.tinhtrangbenh);
      const byFarm = agg(r=>r.tennt);
      const byLot = agg(r=>r.tenlo);
      const byYear = data.reduce((m,r)=>{
        const y = Number(r.nam_trong || (r.ngaytrong? String(r.ngaytrong).slice(0,4): ''));
        if (!isNaN(y) && y>0) { m[y] = (m[y]||0)+1; }
        return m;
      }, {});
      const makeBar = (canvasId, obj, label)=>{
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(obj);
        const values = Object.values(obj);
        if (reportCharts[canvasId]) { reportCharts[canvasId].destroy(); }
        reportCharts[canvasId] = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets:[{ label, data: values, backgroundColor:'#3498db' }] },
          options: { responsive: true, plugins:{ 
              legend:{ display:false }, 
              tooltip:{ bodyFont:{ size:10 }, titleFont:{ size:10 } },
              legendCallback: (chart)=> chart
            }, 
            scales:{ x:{ ticks:{ color:'#2c3e50', font:{ size:10 } } }, y:{ ticks:{ color:'#2c3e50', font:{ size:10 } }, beginAtZero:true } } }
        });
      };
      const makePie = (canvasId, obj, label)=>{
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(obj);
        const values = Object.values(obj);
        const colors = labels.map((_,i)=> `hsl(${(i*53)%360} 70% 55%)`);
        if (reportCharts[canvasId]) { reportCharts[canvasId].destroy(); }
        reportCharts[canvasId] = new Chart(ctx, {
          type: 'pie',
          data: { labels, datasets:[{ label, data: values, backgroundColor: colors }] },
          options: { responsive: true, plugins:{ 
              legend:{ position:'bottom', labels:{ 
                font:{ size:10 }, 
                generateLabels: (chart)=>{
                  const ds = chart.data.datasets[0] || {data:[]};
                  const total = ds.data.reduce((a,b)=>a+(Number(b)||0),0) || 0;
                  return chart.data.labels.map((lbl, i)=>{
                    const val = Number(ds.data[i]||0);
                    const pct = total? ((val/total)*100).toFixed(1): '0.0';
                    const meta = chart.getDatasetMeta(0);
                    const color = (chart.data.datasets[0].backgroundColor||[])[i] || '#999';
                    return {
                      text: `${lbl}: ${val} (${pct}%)`,
                      fillStyle: color,
                      strokeStyle: color,
                      hidden: meta && meta.data[i] ? meta.data[i].hidden : false,
                      index: i
                    };
                  });
                }
              } }, 
              tooltip:{ bodyFont:{ size:10 }, titleFont:{ size:10 } } 
            }
          }
        });
      };
      const makeLine = (canvasId, obj, label)=>{
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(obj).sort((a,b)=>Number(a)-Number(b));
        const values = labels.map(k=> obj[k]);
        if (reportCharts[canvasId]) { reportCharts[canvasId].destroy(); }
        reportCharts[canvasId] = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets:[{ label, data: values, borderColor:'#e67e22', backgroundColor:'rgba(230,126,34,0.15)', tension:0.25, pointRadius:2 }] },
          options: { responsive:true, plugins:{ legend:{ display:false }, tooltip:{ bodyFont:{ size:10 }, titleFont:{ size:10 } } }, scales:{ x:{ ticks:{ color:'#2c3e50', font:{ size:10 } } }, y:{ ticks:{ color:'#2c3e50', font:{ size:10 } }, beginAtZero:true } } }
        });
      };

      // Ch·ªçn d·∫°ng bi·ªÉu ƒë·ªì ph√π h·ª£p: lo·∫°i/ql d√πng c·ªôt n·∫øu danh m·ª•c nhi·ªÅu, ch·∫•t l∆∞·ª£ng/b·ªánh d√πng tr√≤n
      const manyCats = (obj)=> Object.keys(obj).length > 8;
      (manyCats(byType)? makeBar: makePie)('chartTypes', byType, 'S·ªë c√¢y');
      makePie('chartQuality', byQuality, 'T·ª∑ tr·ªçng');
      makePie('chartDisease', byDisease, 'T·ª∑ tr·ªçng');
      (manyCats(byFarm)? makeBar: makePie)('chartFarm', byFarm, 'S·ªë c√¢y');
      (manyCats(byLot)? makeBar: makePie)('chartLot', byLot, 'S·ªë c√¢y');
      if (Object.keys(byYear).length>0) { makeLine('chartYear', byYear, 'S·ªë c√¢y theo nƒÉm'); }

      // T·∫°o b·∫£ng s·ªë li·ªáu chi ti·∫øt d∆∞·ªõi m·ªói bi·ªÉu ƒë·ªì
      const toTable = (obj, total)=>{
        const rows = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
        const pct = (n)=> total? ((n/total)*100).toFixed(1): '0.0';
        let html = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
        html += '<tr><th style="text-align:left; border-bottom:1px solid #eee; padding:4px;">T√™n</th><th style="text-align:right; border-bottom:1px solid #eee; padding:4px;">S·ªë l∆∞·ª£ng</th><th style="text-align:right; border-bottom:1px solid #eee; padding:4px;">T·ª∑ l·ªá</th><th style="text-align:left; border-bottom:1px solid #eee; padding:4px;">ƒê∆°n v·ªã</th></tr>';
        rows.forEach(([k,v])=>{
          html += `<tr><td style="padding:4px; text-align:left;">${k}</td><td style="padding:4px; text-align:right;">${v}</td><td style=\"padding:4px; text-align:right;\">${pct(v)}%</td><td style="padding:4px; text-align:left;">c√¢y</td></tr>`;
        });
        html += '</table>';
        return html;
      };
      const total = data.length || 0;
      document.getElementById('tblType').innerHTML = toTable(byType, total);
      document.getElementById('tblQuality').innerHTML = toTable(byQuality, total);
      document.getElementById('tblDisease').innerHTML = toTable(byDisease, total);
      document.getElementById('tblFarm').innerHTML = toTable(byFarm, total);
      document.getElementById('tblLot').innerHTML = toTable(byLot, total);
      if (document.getElementById('tblYear')) {
        const rows = Object.entries(byYear).sort((a,b)=>Number(a[0])-Number(b[0]));
        let html = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
        html += '<tr><th style="text-align:left; border-bottom:1px solid #eee; padding:4px;">NƒÉm</th><th style="text-align:right; border-bottom:1px solid #eee; padding:4px;">S·ªë l∆∞·ª£ng</th><th style="text-align:left; border-bottom:1px solid #eee; padding:4px;">ƒê∆°n v·ªã</th></tr>';
        rows.forEach(([y,v])=>{ html += `<tr><td style="padding:4px; text-align:left;">${y}</td><td style="padding:4px; text-align:right;">${v}</td><td style="padding:4px; text-align:left;">c√¢y</td></tr>`; });
        html += '</table>';
        document.getElementById('tblYear').innerHTML = html;
      }

      // Ph√¢n t√≠ch AI theo ti√™u ƒë·ªÅ (chuy√™n gia n√¥ng nghi·ªáp)
      const top = (obj)=> Object.entries(obj).sort((a,b)=>b[1]-a[1])[0] || ['(N/A)',0];
      const [tt,ttc]=top(byType); const [dq,dqc]=top(byQuality); const [db,dbc]=top(byDisease); const [nf,nfc]=top(byFarm);
      const p=(n)=> total? ((n/total)*100).toFixed(1):'0.0';
      setText('insType', `‚Äì Lo·∫°i tr·ªôi: ${tt} (${p(ttc)}%). Khuy·∫øn ngh·ªã ∆∞u ti√™n gi·ªëng/ƒë·∫ßu t∆∞.`);
      setText('insQuality', `‚Äì Ch·∫•t l∆∞·ª£ng tr·ªôi: ${dq} (${p(dqc)}%). Chu·∫©n h√≥a quy tr√¨nh n√¢ng t·ª∑ l·ªá.`);
      setText('insDisease', `‚Äì B·ªánh n·ªïi b·∫≠t: ${db} (${p(dbc)}%). Gi√°m s√°t s·ªõm, l·∫≠p l·ªãch x·ª≠ l√Ω.`);
      setText('insFarm', `‚Äì N√¥ng tr∆∞·ªùng nhi·ªÅu c√¢y: ${nf} (${p(nfc)}%). ƒêi·ªÅu ph·ªëi nh√¢n l·ª±c/v·∫≠t t∆∞.`);
      const [lotTop, lotCnt] = top(byLot);
      if (document.getElementById('insLot')) setText('insLot', `‚Äì L√¥ n·ªïi tr·ªôi: ${lotTop} (${p(lotCnt)}%).`);
      if (document.getElementById('insYear')) {
        const yearKeys = Object.keys(byYear).map(Number).sort((a,b)=>a-b);
        const yearSpan = yearKeys.length? `${yearKeys[0]}‚Äì${yearKeys[yearKeys.length-1]}` : 'N/A';
        setText('insYear', `‚Äì Kho·∫£ng nƒÉm: ${yearSpan}.`);
      }

      // T·ªïng h·ª£p g·ª£i √Ω AI v√†o h·ªôp insights
      const insightsEl = document.getElementById('reportInsights');
      if (insightsEl) {
        const top2 = (obj)=> Object.entries(obj).sort((a,b)=>b[1]-a[1])[0] || ['(N/A)',0];
        const [topType2, topTypeCnt2] = top2(byType);
        const [topDisease2, topDisCnt2] = top2(byDisease);
        const pct2 = (n)=> total? ((n/total)*100).toFixed(1): '0.0';
        const years = Object.keys(byYear).map(Number).filter(n=>!isNaN(n));
        const yearSpan = years.length? `${Math.min(...years)}‚Äì${Math.max(...years)}` : 'N/A';
        insightsEl.innerHTML = `
          <div>- Lo·∫°i c√¢y n·ªïi tr·ªôi: <b>${topType2}</b> (${topTypeCnt2} c√¢y, ${pct2(topTypeCnt2)}%). ∆Øu ti√™n gi·ªëng/chu·ªói cung ·ª©ng.</div>
          <div>- B·ªánh ph·ªï bi·∫øn: <b>${topDisease2}</b> (${topDisCnt2} ca, ${pct2(topDisCnt2)}%). L·∫≠p l·ªãch ph√≤ng tr·ªã s·ªõm theo ng∆∞·ª°ng.</div>
          <div>- Ph√¢n b·ªë theo l√¥ v√† n√¥ng tr∆∞·ªùng c√≥ ch√™nh l·ªách. ƒêi·ªÅu ph·ªëi nh√¢n l·ª±c/v·∫≠t t∆∞ sang n∆°i m·∫≠t ƒë·ªô cao.</div>
          <div>- Xu h∆∞·ªõng theo th·ªùi gian (${yearSpan}): ${years.length? 'theo d√µi bi·∫øn ƒë·ªông s·ªë c√¢y/ghi nh·∫≠n' : 'ch∆∞a c√≥ c·ªôt nƒÉm/Ng√†y tr·ªìng'}.</div>
          <div>- G·ª£i √Ω k·ªπ thu·∫≠t: t·ªëi ∆∞u m·∫≠t ƒë·ªô, t∆∞·ªõi/b√≥n theo d·ªØ li·ªáu; th√≠ ƒëi·ªÉm IoT ·ªü l√¥ r·ªßi ro.</div>
        `;
      }
    }
    function closeReportModal(){
      const modal = document.getElementById('reportModal');
      modal.style.display = 'none';
    }
    // B·∫£o ƒë·∫£m n√∫t ho·∫°t ƒë·ªông ngay c·∫£ khi thu·ªôc t√≠nh inline b·ªã ch·∫∑n
    document.addEventListener('DOMContentLoaded', function(){
      const btn = document.getElementById('openReportBtn');
      if (btn) btn.addEventListener('click', function(ev){ ev.preventDefault(); try { openReportModal(); } catch(err){ console.error(err); alert('L·ªói m·ªü b√°o c√°o: '+err.message); } });
      const modal = document.getElementById('reportModal');
      if (modal) { modal.addEventListener('click', (e)=>{ if (e.target===modal) closeReportModal(); }); }
    });
  </script>
  <!-- Modal b√°o c√°o v·ªõi bi·ªÉu ƒë·ªì -->
  <div id="reportModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:2002;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; border-radius:10px; padding:14px; width:860px; max-width:96vw; max-height:90vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">üìä B√°o c√°o tr·ª±c quan</h3>
        <button onclick="closeReportModal()" style="background:#e74c3c; color:white; border:none; border-radius:1px; padding:2px 5px; cursor:pointer; transform: scaleX(0.3); transform-origin: right center;">ƒê√≥ng</button>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start;">
        <div id="reportLeftCol" style="display:flex; flex-direction:column; gap:10px; border-right:1px solid #e1e5ea; padding-right:10px;">
          <div>
            <h4 style="margin:6px 0; border-bottom:1px solid #e9ecef; padding-bottom:4px;">üå≥ Lo·∫°i c√¢y <span id="insType" style="font-weight:600; color:#2c3e50; font-size:12px;"></span></h4>
            <canvas id="chartTypes" height="12"></canvas>
            <div style="height:1px; background:#e9ecef; margin:6px 0;"></div>
          </div>
          <div>
            <h4 style="margin:6px 0; border-bottom:1px solid #e9ecef; padding-bottom:4px;">üå± Ch·∫•t l∆∞·ª£ng <span id="insQuality" style="font-weight:600; color:#2c3e50; font-size:12px;"></span></h4>
            <canvas id="chartQuality" height="12"></canvas>
            <div style="height:1px; background:#e9ecef; margin:6px 0;"></div>
          </div>
          <div>
            <h4 style="margin:6px 0; border-bottom:1px solid #e9ecef; padding-bottom:4px;">ü¶† D·ªãch b·ªánh <span id="insDisease" style="font-weight:600; color:#2c3e50; font-size:12px;"></span></h4>
            <canvas id="chartDisease" height="12"></canvas>
            <div style="height:1px; background:#e9ecef; margin:6px 0;"></div>
          </div>
          <div>
            <h4 style="margin:6px 0; border-bottom:1px solid #e9ecef; padding-bottom:4px;">üë• N√¥ng tr∆∞·ªùng <span id="insFarm" style="font-weight:600; color:#2c3e50; font-size:12px;"></span></h4>
            <canvas id="chartFarm" height="12"></canvas>
            <div style="height:1px; background:#e9ecef; margin:6px 0;"></div>
          </div>
          <div>
            <h4 style="margin:6px 0; border-bottom:1px solid #e9ecef; padding-bottom:4px;">üì¶ Theo L√¥ <span id="insLot" style="font-weight:600; color:#2c3e50; font-size:12px;"></span></h4>
            <canvas id="chartLot" height="12"></canvas>
            <div style="height:1px; background:#e9ecef; margin:6px 0;"></div>
          </div>
          <div>
            <h4 style="margin:6px 0; border-bottom:1px solid #e9ecef; padding-bottom:4px;">üìÖ Theo th·ªùi gian <span id="insYear" style="font-weight:600; color:#2c3e50; font-size:12px;"></span></h4>
            <canvas id="chartYear" height="12"></canvas>
          </div>
        </div>
        <div id="reportRightCol" style="display:flex; flex-direction:column; gap:10px; border-left:1px solid #e1e5ea; padding-left:10px;">
          <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:8px;">
            <h4 style="margin:4px 0;">üóÇÔ∏è Kh√°i qu√°t d·ªØ li·ªáu</h4>
            <div id="datasetOverview" style="font-size:12px; color:#2c3e50;"></div>
          </div>
          <div>
            <h4 style="margin:6px 0;">B·∫£ng s·ªë li·ªáu</h4>
            <div id="tblType" style="margin-bottom:8px; border-top:1px dashed #e1e5ea; padding-top:6px;"></div>
            <div id="tblQuality" style="margin-bottom:8px; border-top:1px dashed #e1e5ea; padding-top:6px;"></div>
            <div id="tblDisease" style="margin-bottom:8px; border-top:1px dashed #e1e5ea; padding-top:6px;"></div>
            <div id="tblFarm" style="margin-bottom:8px; border-top:1px dashed #e1e5ea; padding-top:6px;"></div>
            <div id="tblLot" style="margin-bottom:8px; border-top:1px dashed #e1e5ea; padding-top:6px;"></div>
            <div id="tblYear" style="margin-bottom:8px; border-top:1px dashed #e1e5ea; padding-top:6px;"></div>
          </div>
          <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:10px;">
            <h4 style="margin:0 0 8px 0;">ü§ñ G·ª£i √Ω ph√¢n t√≠ch & gi·∫£i ph√°p (AI)</h4>
            <div id="reportInsights" style="font-size:13px; line-height:1.5; color:#2c3e50;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  
  <!-- Panel b·∫£n ƒë·ªì nh·ªè n·∫±m ngang -->
  <div class="map-panel-horizontal" id="mapPanel">
    <div class="map-panel-header" onmousedown="startDrag(event, 'mapPanel')">
      <h4>üó∫Ô∏è</h4>
      <div class="map-panel-controls">
        <button class="minimize-btn" onclick="toggleMapPanel()" title="Thu g·ªçn">‚àí</button>
        </div>
    </div>
    <div class="map-panel-content">
      <div class="map-tool-horizontal">
        <button class="map-tool-btn-small" onclick="zoomToAll()" title="Xem to√†n b·ªô">üîé</button>
        <button class="map-tool-btn-small" onclick="toggleClustering()" id="clusterBtn" title="B·∫≠t/T·∫Øt clustering">üìä</button>
        <button class="map-tool-btn-small" onclick="startPolygonDrawing()" id="polygonBtn" title="V·∫Ω ƒëa gi√°c">
          <span style="display:inline-block; width: 0; height: 0; border-bottom: 10px solid black; border-left: 6px solid transparent; border-right: 6px solid transparent; transform: scaleX(1.2);"></span>
        </button>
        <button class="map-tool-btn-small" onclick="startDistanceMeasure()" id="distanceBtn" title="ƒêo kho·∫£ng c√°ch">üìè</button>
        <button class="map-tool-btn-small" onclick="countTreesInArea()" title="ƒê·∫øm c√¢y">üå≥</button>
        <button class="map-tool-btn-small" onclick="clearDrawings()" title="X√≥a v·∫Ω">üóëÔ∏è</button>
      </div>
    </div>
  </div>
  
  
  
  <div class="status-bar" id="statusBar">
    S·∫µn s√†ng | T·ªça ƒë·ªô: -- | Zoom: -- | C√¢y: 0
  </div>
  
  <div class="edit-modal" id="editModal">
    <h3>‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin c√¢y</h3>
    <form id="editForm">
      <label for="editId">ID:</label>
      <input type="text" id="editId" readonly />
      
      <label for="editTen">T√™n c√¢y:</label>
      <input type="text" id="editTen" />
      
      <label for="editMauCay">M√†u c√¢y (lo·∫°i c√¢y):</label>
      <input type="text" id="editMauCay" />
      
      <label for="editNam">NƒÉm tr·ªìng:</label>
      <input type="number" id="editNam" min="1900" max="2030" />
      
      <label for="editNgayTrong">Ng√†y tr·ªìng (dd/mm/yyyy):</label>
      <input type="text" id="editNgayTrong" placeholder="dd/mm/yyyy" />
      
      <label for="editChatLuong">Ch·∫•t l∆∞·ª£ng:</label>
      <input type="text" id="editChatLuong" />
      
      <label for="editMau">M√†u s·∫Øc (ch·∫•t l∆∞·ª£ng):</label>
      <input type="text" id="editMau" />
      
      <label for="editTinhtrangbenh">T√¨nh tr·∫°ng b·ªánh:</label>
      <input type="text" id="editTinhtrangbenh" />
      
      <label for="editTennt">T√™n n√¥ng tr∆∞·ªùng:</label>
      <input type="text" id="editTennt" />
      
      <label for="editTengd">T√™n gi√°m ƒë·ªëc:</label>
      <input type="text" id="editTengd" />
      
      <label for="editTendoi">T√™n ƒë·ªôi:</label>
      <input type="text" id="editTendoi" />
      
      <label for="editTendt">T√™n ƒë·ªôi tr∆∞·ªüng:</label>
      <input type="text" id="editTendt" />
      
      <label for="editTenlo">T√™n l√¥:</label>
      <input type="text" id="editTenlo" />
      
      <label for="editTentt">T√™n t·ªï tr∆∞·ªüng:</label>
      <input type="text" id="editTentt" />
      
      <label for="editCn">T√™n c√¥ng nh√¢n:</label>
      <input type="text" id="editCn" />
      
      <div class="button-group">
        <button type="button" class="cancel-btn" onclick="closeEditModal()">H·ªßy</button>
        <button type="button" class="save-btn" onclick="saveTreeEditModal()">L∆∞u</button>
        <button type="button" class="export-btn" onclick="exportEditedData()">Xu·∫•t Excel</button>
      </div>
    </form>
  </div>
  
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <script>
    // H·ªá t·ªça ƒë·ªô VN2000 m√∫i 3¬∞, kinh tuy·∫øn tr·ª•c 108.5¬∞ (cho Gia Lai)
    // ƒê√¢y l√† h·ªá t·ªça ƒë·ªô chu·∫©n cho AutoCAD t·∫°i Vi·ªát Nam
    proj4.defs("VN2000_GIA_LAI",
      "+proj=tmerc +lat_0=0 +lon_0=108.5 +k=0.9999 +x_0=500000 +y_0=0 " +
      "+ellps=WGS84 +towgs84=-191.904414,-39.303182,-111.450328,0.00928836,-0.01975479,0.00427372,1 " +
      "+units=m +no_defs"
    );
    
    // Th√¥ng tin h·ªá t·ªça ƒë·ªô VN2000 Gia Lai
    console.log('H·ªá t·ªça ƒë·ªô VN2000 Gia Lai - Kinh tuy·∫øn tr·ª•c: 108.5¬∞, M√∫i chi·∫øu: 3¬∞');
    const VN2000 = proj4("VN2000_GIA_LAI");
    const WGS84 = proj4("WGS84");

    // T·∫°o b·∫£n ƒë·ªì
    const map = L.map('map', { zoomControl: false, maxZoom: 20, minZoom: 8 })
      .setView([13.95, 108.0], 15);

    const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
      attribution: 'Google Hybrid', maxZoom: 20
    });
    
    const googleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: 'Google Satellite', maxZoom: 20
    });

    const baseMaps = {
      "Hybrid": googleHybrid,
      "Satellite": googleSatellite
    };

    googleHybrid.addTo(map);
    L.control.layers(baseMaps).addTo(map);

    let markers = [];
    let markerGroup = L.featureGroup().addTo(map);
    let markerClusterGroup = L.markerClusterGroup({
      chunkedLoading: true,
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      disableClusteringAtZoom: 16 // T·∫Øt clustering khi zoom >= 16
    });
    let allTreeData = [];
    let editedTreesList = new Set(); // Danh s√°ch ID c√°c c√¢y ƒë√£ ch·ªânh s·ª≠a
    let clusteringEnabled = true;

    // C√¥ng c·ª• v·∫Ω ƒëa gi√°c
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    let currentDrawingMode = null;
    let polygonHandler = null;
    
    // C√¥ng c·ª• ƒëo kho·∫£ng c√°ch
    let distanceMode = false;
    let distancePoints = [];
    let distanceLines = [];
    let distanceMarkers = [];
    let distanceLayer = L.layerGroup().addTo(map);

    // Event listeners
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    document.getElementById('statusFilter').addEventListener('change', filterMarkers);
    document.getElementById('typeFilter').addEventListener('change', filterMarkers);
    document.getElementById('yearFilter').addEventListener('input', filterMarkers);
    document.getElementById('tenntFilter').addEventListener('change', filterMarkers);
    document.getElementById('tendoiFilter').addEventListener('change', filterMarkers);
    document.getElementById('tenloFilter').addEventListener('change', filterMarkers);
    document.getElementById('tenttFilter').addEventListener('change', filterMarkers);
    document.getElementById('cnFilter').addEventListener('change', filterMarkers);
    document.getElementById('diseaseFilter').addEventListener('change', filterMarkers);
    
    // Event delegation cho popup buttons
    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action]')) {
        const action = e.target.getAttribute('data-action');
        const id = e.target.getAttribute('data-id');
        
        console.log('Popup button clicked:', action, id);
        
        switch(action) {
          case 'edit':
            switchToEditMode(id);
            break;
          case 'save':
            saveTreeEdit(id);
            break;
          case 'cancel':
            switchToViewMode(id);
            break;
          case 'close':
            closePopup(id);
            break;
          case 'toggle':
            togglePopupContent(id);
            break;
        }
      }
    });
    // T·ª± ƒë·ªông n·∫°p URL Google Sheets ƒë√£ l∆∞u khi m·ªü trang
    (function autoLoadGoogleSheet(){
      try {
        const saved = localStorage.getItem('googleSheetUrl');
        if (saved) {
          const el = document.getElementById('googleSheetUrl');
          if (el) el.value = saved;
          // Tr√¨ ho√£n m·ªôt nh·ªãp ƒë·ªÉ map/UI s·∫µn s√†ng
          setTimeout(()=>{ loadFromGoogleSheet(); }, 600);
        }
      } catch(err){ console.warn('AutoLoad GSheet skip:', err); }
    })();
    
    // T√≠nh b√°n k√≠nh marker theo m·ª©c zoom (nh·ªè h∆°n khi zoom ra xa)
    function getRadiusForZoom(zoom) {
      // Theo y√™u c·∫ßu: Z20=7, Z19=3, Z18=0.2, Z17..9=0.1
      if (zoom >= 20) return 7.0;
      if (zoom === 19) return 3.0;
      if (zoom === 18) return 0.2;
      if (zoom <= 17) return 0.1; // √°p d·ª•ng cho 17 xu·ªëng 9
      return 0.1;
    }

    function updateMarkerSizes() {
      const currentZoom = map.getZoom();
      const r = getRadiusForZoom(currentZoom);
      markers.forEach(m => {
        // gi·ªØ opacity hi·ªán t·∫°i, ch·ªâ c·∫≠p nh·∫≠t radius
        m.setStyle({ radius: r });
      });
    }

    // Event listener ƒë·ªÉ c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc markers khi zoom
    map.on('zoomend', updateMarkerSizes);

    // C·∫≠p nh·∫≠t status bar
    map.on('mousemove', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      const zoom = map.getZoom();
      document.getElementById('statusBar').textContent = 
        `T·ªça ƒë·ªô: ${lat}, ${lng} | Zoom: ${zoom} | C√¢y: ${markers.length}`;
    });
    
    // Event listener cho ƒëo kho·∫£ng c√°ch
    map.on('click', function(e) {
      if (distanceMode) {
        addDistancePoint(e.latlng);
      }
    });

    // ==== GOOGLE SHEETS LOADER ====
    function saveGoogleSheetUrl(){
      try {
        const url = (document.getElementById('googleSheetUrl')?.value || '').trim();
        if (!url) { alert('Vui l√≤ng nh·∫≠p URL Google Sheets'); return; }
        localStorage.setItem('googleSheetUrl', url);
        alert('ƒê√£ l∆∞u URL Google Sheets. Trang s·∫Ω t·ª± t·∫£i d·ªØ li·ªáu khi m·ªü.');
      } catch(err){ console.error(err); alert('L·ªói l∆∞u URL: '+err.message); }
    }

    function getParam(url, name){
      try { const u = new URL(url); return u.searchParams.get(name) || ''; } catch { return ''; }
    }

    function buildGoogleCsvUrl(sheetUrl){
      try {
        // N·∫øu ƒë√£ l√† CSV (publish to web ho·∫∑c gviz out:csv), tr·∫£ v·ªÅ tr·ª±c ti·∫øp
        if (sheetUrl.includes('tqx=out:csv') || sheetUrl.endsWith('.csv')) return sheetUrl;
        const u = new URL(sheetUrl);
        const parts = u.pathname.split('/');
        const idIndex = parts.indexOf('d') + 1;
        const docId = parts[idIndex] || '';
        const gid = getParam(sheetUrl, 'gid') || '0';
        if (!docId) return sheetUrl; // kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c => d√πng nguy√™n b·∫£n
        // ∆Øu ti√™n gviz CSV; n·∫øu Publish to web ƒë∆∞·ª£c b·∫≠t, ƒë∆∞·ªùng d·∫´n /pub c≈©ng h·ª£p l·ªá
        return `https://docs.google.com/spreadsheets/d/${docId}/gviz/tq?tqx=out:csv&gid=${gid}`;
      } catch {
        return sheetUrl;
      }
    }

    function buildOneDriveDirectUrl(raw){
      // Chu·∫©n h√≥a c√°c bi·∫øn th·ªÉ link OneDrive th√†nh link t·∫£i tr·ª±c ti·∫øp
      try {
        const u = new URL(raw);
        const host = u.host.toLowerCase();
        // 1drv.ms short link ‚Üí th√™m download=1
        if (host.includes('1drv.ms')) {
          if (!u.searchParams.has('download')) u.searchParams.set('download', '1');
          return u.toString();
        }
        // onedrive.live.com/view.aspx?resid=... ‚Üí download?resid=...
        if (host.includes('onedrive.live.com')) {
          if (u.pathname.toLowerCase().includes('/view.aspx')) {
            const resid = u.searchParams.get('resid');
            const authkey = u.searchParams.get('authkey');
            const downloadUrl = new URL('https://onedrive.live.com/download');
            if (resid) downloadUrl.searchParams.set('resid', resid);
            if (authkey) downloadUrl.searchParams.set('authkey', authkey);
            return downloadUrl.toString();
          }
        }
      } catch {}
      return raw;
    }

    async function loadFromGoogleSheet(){
      try {
        const inputEl = document.getElementById('googleSheetUrl');
        const inputUrl = (inputEl?.value || '').trim();
        const savedUrl = (localStorage.getItem('googleSheetUrl') || '').trim();
        const urlRaw = inputUrl || savedUrl;
        if (!urlRaw) { alert('Ch∆∞a c√≥ URL Google Sheets'); return; }
        // H·ªó tr·ª£ Google Sheets v√† OneDrive
        const isOneDrive = /onedrive\.live\.com|1drv\.ms/i.test(urlRaw);
        const url = isOneDrive ? buildOneDriveDirectUrl(urlRaw) : buildGoogleCsvUrl(urlRaw);
        // Quy·∫øt ƒë·ªãnh CSV hay XLSX theo ƒëu√¥i/param
        const isCsv = url.endsWith('.csv') || url.includes('tqx=out:csv') || /output=csv/i.test(url);
        if (isCsv) {
          let res;
          const proxy = 'https://cors.isomorphic-git.org/';
          try {
            res = await fetch(url, { mode: 'cors' });
            if (!res.ok) {
              // th·ª≠ l·∫°i qua proxy khi status kh√¥ng OK
              res = await fetch(proxy + url, { mode: 'cors' });
            }
          } catch(fetchErr) {
            // Th·ª≠ proxy CORS nh·∫π n·∫øu tr√¨nh duy·ªát ch·∫∑n do Origin:null (file://)
            res = await fetch(proxy + url, { mode: 'cors' });
          }
          if (!res.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c CSV: ' + res.status);
          const text = await res.text();
          // Parse CSV v·ªÅ m·∫£ng ƒë·ªëi t∆∞·ª£ng theo header
          const data = parseCSV(text);
          if (!Array.isArray(data) || data.length === 0) { alert('CSV r·ªóng/kh√¥ng h·ª£p l·ªá'); return; }
          addTreesToMap(data);
          if (inputEl && !inputEl.value) inputEl.value = urlRaw;
          document.getElementById('statusBar').textContent = `ƒê√£ t·∫£i ${data.length} d√≤ng t·ª´ ${isOneDrive ? 'OneDrive' : 'Google Sheets'} (CSV)`;
          return;
        }
        // Th·ª≠ t·∫£i d·∫°ng XLSX (export)
        const xlsxUrl = isOneDrive ? url : (url.includes('/export') ? url : (urlRaw.includes('/export') ? urlRaw : `${urlRaw.replace(/\/?edit.*$/, '')}/export?format=xlsx`));
        let r;
        const proxy = 'https://cors.isomorphic-git.org/';
        try {
          r = await fetch(xlsxUrl, { mode: 'cors' });
          if (!r.ok) {
            r = await fetch(proxy + xlsxUrl, { mode: 'cors' });
          }
        } catch(fetchErr) {
          r = await fetch(proxy + xlsxUrl, { mode: 'cors' });
        }
        if (!r.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c XLSX: ' + r.status);
        const buf = await r.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const sheetName = wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet);
        addTreesToMap(json);
        if (inputEl && !inputEl.value) inputEl.value = urlRaw;
        document.getElementById('statusBar').textContent = `ƒê√£ t·∫£i ${json.length} d√≤ng t·ª´ ${isOneDrive ? 'OneDrive' : 'Google Sheets'} (XLSX)`;
      } catch(err){
        console.error(err);
        alert('L·ªói t·∫£i d·ªØ li·ªáu: ' + err.message + '\nC√°ch kh·∫Øc ph·ª•c:\n1) B·∫≠t chia s·∫ª c√¥ng khai (Anyone with the link).\n2) Google: d√πng CSV (/gviz ... out:csv) ho·∫∑c /export?format=xlsx.\n3) OneDrive: d√πng link 1drv.ms v·ªõi ?download=1 ho·∫∑c live.com/download?resid=...\n4) M·ªü trang qua http://localhost thay v√¨ file://');
      }
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          if (file.name.endsWith('.csv')) {
            parseCSV(event.target.result);
          } else {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);
            
            addTreesToMap(json);
          }
        } catch (error) {
          console.error('L·ªói ƒë·ªçc file: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = lines[i].split(',').map(v => v.trim());
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }
      }
      
      addTreesToMap(data);
    }

    function addTreesToMap(data) {
      allTreeData = data;
      clearMarkers();
      
      let tong = 0;
      let chatLuongStats = {};
      let loaiCayStats = {};
      let colorStats = {};

      data.forEach(row => {
        // C√°c tr∆∞·ªùng ch√≠nh - ∆∞u ti√™n c·ªôt 'id' t·ª´ Excel
        const id = (row.id || row.ID || row.Id || '').toString().trim();
        const ten = row.ten || ''; // T√™n c√¢y - tr∆∞·ªùng ch√≠nh
        const namTrong = row.nam_trong || ''; // NƒÉm tr·ªìng - tr∆∞·ªùng ch√≠nh
        const ngayTrong = row.ngaytrong || ''; // Ng√†y tr·ªìng - tr∆∞·ªùng ch√≠nh
        console.log('Ng√†y tr·ªìng t·ª´ Excel:', { ngayTrong, type: typeof ngayTrong, row: row.ngaytrong });
        const chatLuong = row.chat_luong || ''; // Ch·∫•t l∆∞·ª£ng - tr∆∞·ªùng ch√≠nh
        const tinhtrangbenh = row.tinhtrangbenh || ''; // T√¨nh tr·∫°ng b·ªánh - tr∆∞·ªùng ch√≠nh
        
        // C√°c tr∆∞·ªùng d·ªØ li·ªáu m·ªõi
        const tennt = row.tennt || ''; // T√™n n√¥ng tr∆∞·ªùng
        const tengd = row.tengd || ''; // T√™n gi√°m ƒë·ªëc n√¥ng tr∆∞·ªùng
        const tendoi = row.tendoi || ''; // T√™n ƒë·ªôi
        const tendt = row.tendt || ''; // T√™n ƒë·ªôi tr∆∞·ªüng
        const tenlo = row.tenlo || ''; // T√™n l√¥
        const tentt = row.tentt || ''; // T√™n t·ªï tr∆∞·ªüng
        const cn = row.cn || ''; // C√¥ng nh√¢n
        
        // C√°c tr∆∞·ªùng m√†u s·∫Øc
        const mauCay = row.mau_cay || ''; // M√†u s·∫Øc c·ªßa t√™n c√¢y
        const mau = row.mau || ''; // M√†u s·∫Øc c·ªßa ch·∫•t l∆∞·ª£ng
        
        const lat = parseFloat(row.lat);
        const lon = parseFloat(row.lon);

        if (isNaN(lat) || isNaN(lon)) return;

        // Debug: Hi·ªÉn th·ªã th√¥ng tin ID v√† t·ªça ƒë·ªô
        console.log(`C√¢y ID: "${id}" | T·ªça ƒë·ªô VN2000 (AutoCAD) - X: ${lat}, Y: ${lon}`);
        console.log(`Th√¥ng tin qu·∫£n l√Ω - N√¥ng tr∆∞·ªùng: "${tennt}", Gi√°m ƒë·ªëc: "${tengd}"`);

        // X√°c ƒë·ªãnh m√†u s·∫Øc marker - m·∫∑c ƒë·ªãnh hi·ªÉn th·ªã m√†u c·ªßa t√™n c√¢y
        let markerColor = 'green'; // m·∫∑c ƒë·ªãnh
        
        // ∆Øu ti√™n 1: mau_cay (m√†u s·∫Øc c·ªßa t√™n c√¢y) - hi·ªÉn th·ªã khi kh√¥ng l·ªçc
        if (mauCay) {
          markerColor = mauCay.toLowerCase();
        } 
        // ∆Øu ti√™n 2: mau (m√†u s·∫Øc c·ªßa ch·∫•t l∆∞·ª£ng) - hi·ªÉn th·ªã khi l·ªçc theo ch·∫•t l∆∞·ª£ng
        else if (mau) {
          markerColor = mau.toLowerCase();
        } 
        // ∆Øu ti√™n 3: chat_luong (ch·∫•t l∆∞·ª£ng) - fallback
        else if (chatLuong.toLowerCase().includes('t·ªët') || chatLuong.toLowerCase().includes('excellent')) {
          markerColor = 'green';
        } else if (chatLuong.toLowerCase().includes('trung b√¨nh') || chatLuong.toLowerCase().includes('good')) {
          markerColor = 'orange';
        } else if (chatLuong.toLowerCase().includes('x·∫•u') || chatLuong.toLowerCase().includes('poor')) {
          markerColor = 'red';
        }

        // Chuy·ªÉn ƒë·ªïi t·ªça ƒë·ªô VN2000 (AutoCAD) -> WGS84 (Google Earth)
        // Trong AutoCAD: lat = X, lon = Y
        // Chuy·ªÉn ƒë·ªïi: (X, Y) = (lat, lon) -> (lon, lat) cho proj4
        const [lonWGS84, latWGS84] = proj4(VN2000, WGS84, [lat, lon]);
        
        // Debug: Hi·ªÉn th·ªã t·ªça ƒë·ªô sau chuy·ªÉn ƒë·ªïi
        console.log(`C√¢y ${id}: VN2000(X=${lat}, Y=${lon}) -> WGS84(${latWGS84.toFixed(6)}, ${lonWGS84.toFixed(6)})`);

        // T√≠nh to√°n k√≠ch th∆∞·ªõc marker d·ª±a tr√™n m·ª©c zoom
        const currentZoom = map.getZoom();
        const markerRadius = getRadiusForZoom(currentZoom);

        const marker = L.circleMarker([latWGS84, lonWGS84], {
          radius: markerRadius, color: markerColor, fillColor: markerColor,
          fillOpacity: 0.8, weight: 2
        }).bindPopup(createViewPopup(id, {
          ten, namTrong, ngayTrong, chatLuong, tinhtrangbenh,
          tennt, tengd, tendoi, tendt, tenlo, tentt, cn
        }));

        // L∆∞u d·ªØ li·ªáu c√¢y v√†o marker
        marker.treeData = { 
          id, ten, namTrong, ngayTrong, chatLuong, tinhtrangbenh, mauCay, mau,
          tennt, tengd, tendoi, tendt, tenlo, tentt, cn,
          markerColor, lat: latWGS84, lon: lonWGS84 
        };
        
        // Th√™m marker v√†o markerGroup ngay l·∫≠p t·ª©c
        marker.addTo(markerGroup);
        markers.push(marker);
        
        // Debug: Ki·ªÉm tra marker c√≥ t·ªça ƒë·ªô h·ª£p l·ªá kh√¥ng
        if (isNaN(latWGS84) || isNaN(lonWGS84)) {
          console.warn(`Marker ${id} c√≥ t·ªça ƒë·ªô kh√¥ng h·ª£p l·ªá: lat=${latWGS84}, lon=${lonWGS84}`);
        } else {
          console.log(`ƒê√£ th√™m marker ${id} v√†o b·∫£n ƒë·ªì t·∫°i t·ªça ƒë·ªô: ${latWGS84.toFixed(6)}, ${lonWGS84.toFixed(6)}`);
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        chatLuongStats[chatLuong] = (chatLuongStats[chatLuong] || 0) + 1;
        loaiCayStats[ten] = (loaiCayStats[ten] || 0) + 1;
        colorStats[markerColor] = (colorStats[markerColor] || 0) + 1;
        tong++;
      });

      updateFilterOptions();
      updateStats(tong, chatLuongStats, loaiCayStats, colorStats);
      updateManagementStats(data);
      updateLegend(colorStats);
      updateDataStatsPanel(data);
      
      // ƒê√£ b·ªè panel th·ªëng k√™
      
      // C·∫≠p nh·∫≠t markers v√† zoom sau khi t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
      updateMarkers();
      // C·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™ theo b·ªô l·ªçc ban ƒë·∫ßu
      updateFilterStatsPanel();
      // B·ªè c·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p ban ƒë·∫ßu
      
      if (markers.length > 0) {
        console.log(`ƒê√£ t·∫°o ${markers.length} markers, markerGroup c√≥ ${markerGroup.getLayers().length} layers`);
        
        // Zoom ngay l·∫≠p t·ª©c v√¨ markers ƒë√£ ƒë∆∞·ª£c th√™m tr·ª±c ti·∫øp v√†o markerGroup
        if (markerGroup.getLayers().length > 0) {
          const bounds = markerGroup.getBounds();
          console.log('Bounds c·ªßa markers:', bounds);
          map.fitBounds(bounds.pad(0.1));
          console.log('ƒê√£ zoom ƒë·∫øn v·ªã tr√≠ c√°c c√¢y');
        } else {
          console.warn('markerGroup kh√¥ng c√≥ layers m·∫∑c d√π c√≥ markers');
        }
        
        // C·∫≠p nh·∫≠t status bar khi load xong d·ªØ li·ªáu
        document.getElementById('statusBar').textContent = 
          `ƒê√£ load ${markers.length} c√¢y t·ª´ file Excel | T·ªça ƒë·ªô: -- | Zoom: -- | C√¢y: ${markers.length}`;
      } else {
        console.warn('Kh√¥ng c√≥ markers ƒë∆∞·ª£c t·∫°o');
      }
    }

    function updateMarkers() {
      if (clusteringEnabled) {
        markerGroup.clearLayers();
        markerClusterGroup.clearLayers();
        markerClusterGroup.addLayers(markers);
        map.addLayer(markerClusterGroup);
        console.log(`updateMarkers v·ªõi clustering: markers.length=${markers.length}`);
      } else {
        markerClusterGroup.clearLayers();
      markerGroup.clearLayers();
      markers.forEach(marker => markerGroup.addLayer(marker));
        console.log(`updateMarkers kh√¥ng clustering: markers.length=${markers.length}`);
      }
    }

    function updateMarkerSizes() {
      const currentZoom = map.getZoom();
      const newRadius = getRadiusForZoom(currentZoom);
      
      // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc cho t·∫•t c·∫£ markers
      markers.forEach(marker => {
        if (marker.setRadius) {
          marker.setRadius(newRadius);
        }
      });
      
      console.log(`ƒê√£ c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc markers: zoom=${currentZoom}, radius=${newRadius}`);
    }

    function clearMarkers() {
      markerGroup.clearLayers();
      markerClusterGroup.clearLayers();
      markers = [];
    }

    function updateFilterOptions() {
      const statusSet = new Set();
      const typeSet = new Set();
      const yearSet = new Set();
      const tenntSet = new Set();
      const tengdSet = new Set();
      const tendoiSet = new Set();
      const tendtSet = new Set();
      const tenloSet = new Set();
      const tenttSet = new Set();
      const cnSet = new Set();
      const diseaseSet = new Set();
      
      // Debug: Hi·ªÉn th·ªã t·∫•t c·∫£ t√™n c·ªôt c√≥ s·∫µn trong d·ªØ li·ªáu
      if (allTreeData.length > 0) {
        console.log('T·∫•t c·∫£ t√™n c·ªôt trong d·ªØ li·ªáu:', Object.keys(allTreeData[0]));
        console.log('D√≤ng ƒë·∫ßu ti√™n:', allTreeData[0]);
      }
      
      allTreeData.forEach(row => {
        const chatLuong = (row.chat_luong || '').trim();
        const ten = (row.ten || '').trim();
        const namTrong = row.nam_trong || '';
        const tennt = (row.tennt || '').trim();
        const tengd = (row.tengd || '').trim(); // T√™n gi√°m ƒë·ªëc n√¥ng tr∆∞·ªùng
        const tendoi = (row.tendoi || '').trim();
        const tendt = (row.tendt || '').trim();
        const tenlo = (row.tenlo || '').trim();
        const tentt = (row.tentt || '').trim();
        const cn = (row.cn || '').trim();
        const tinhtrangbenh = (row.tinhtrangbenh || '').trim();
        
        if (chatLuong) statusSet.add(chatLuong);
        if (ten) typeSet.add(ten);
        if (namTrong && !isNaN(parseInt(namTrong))) {
          yearSet.add(parseInt(namTrong));
        }
        if (tennt) {
          tenntSet.add(tennt);
          console.log('Th√™m n√¥ng tr∆∞·ªùng:', tennt);
        }
        if (tengd) {
          tengdSet.add(tengd);
          console.log('Th√™m gi√°m ƒë·ªëc:', tengd);
        }
        if (tendoi) tendoiSet.add(tendoi);
        if (tendt) tendtSet.add(tendt);
        if (tenlo) tenloSet.add(tenlo);
        if (tentt) tenttSet.add(tentt);
        if (cn) cnSet.add(cn);
        if (tinhtrangbenh) diseaseSet.add(tinhtrangbenh);
      });

      // C·∫≠p nh·∫≠t b·ªô l·ªçc ch·∫•t l∆∞·ª£ng
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.innerHTML = '<option value="">T·∫•t c·∫£ ch·∫•t l∆∞·ª£ng</option>';
        Array.from(statusSet).sort().forEach(chatLuong => {
          statusFilter.innerHTML += `<option value="${chatLuong}">${chatLuong}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc lo·∫°i c√¢y
      const typeFilter = document.getElementById('typeFilter');
      if (typeFilter) {
        typeFilter.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i c√¢y</option>';
        Array.from(typeSet).sort().forEach(type => {
          typeFilter.innerHTML += `<option value="${type}">${type}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc nƒÉm tr·ªìng
      const yearFilter = document.getElementById('yearFilter');
      if (yearFilter) {
        yearFilter.innerHTML = '<option value="">T·∫•t c·∫£ nƒÉm tr·ªìng</option>';
        Array.from(yearSet).sort((a, b) => b - a).forEach(year => {
          yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc n√¥ng tr∆∞·ªùng
      const tenntFilter = document.getElementById('tenntFilter');
      if (tenntFilter) {
        tenntFilter.innerHTML = '<option value="">T·∫•t c·∫£ n√¥ng tr∆∞·ªùng</option>';
        console.log('N√¥ng tr∆∞·ªùng t√¨m th·∫•y:', Array.from(tenntSet));
        console.log('S·ªë l∆∞·ª£ng n√¥ng tr∆∞·ªùng:', tenntSet.size);
        console.log('D·ªØ li·ªáu n√¥ng tr∆∞·ªùng t·ª´ allTreeData:', allTreeData.map(row => ({ tennt: row.tennt, id: row.id })));
        
        if (tenntSet.size === 0) {
          console.warn('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√¥ng tr∆∞·ªùng! Ki·ªÉm tra t√™n c·ªôt trong file Excel.');
          // Th·ª≠ c√°c t√™n c·ªôt kh√°c c√≥ th·ªÉ c√≥
          const possibleTenntColumns = ['tennt', 'TENNT', 'TenNT', 'ten_nt', 'TEN_NT', 'nong_truong', 'NONG_TRUONG'];
          possibleTenntColumns.forEach(col => {
            const found = allTreeData.some(row => row[col]);
            if (found) {
              console.log(`T√¨m th·∫•y c·ªôt n√¥ng tr∆∞·ªùng v·ªõi t√™n: ${col}`);
              allTreeData.forEach(row => {
                const value = (row[col] || '').trim();
                if (value) tenntSet.add(value);
              });
            }
          });
        }
        
        Array.from(tenntSet).sort().forEach(tennt => {
          tenntFilter.innerHTML += `<option value="${tennt}">${tennt}</option>`;
        });
      }



      // C·∫≠p nh·∫≠t b·ªô l·ªçc ƒë·ªôi
      const tendoiFilter = document.getElementById('tendoiFilter');
      if (tendoiFilter) {
        tendoiFilter.innerHTML = '<option value="">T·∫•t c·∫£ ƒë·ªôi</option>';
        Array.from(tendoiSet).sort().forEach(tendoi => {
          tendoiFilter.innerHTML += `<option value="${tendoi}">${tendoi}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc ƒë·ªôi tr∆∞·ªüng
      const tendtFilter = document.getElementById('tendtFilter');
      if (tendtFilter) {
        tendtFilter.innerHTML = '<option value="">T·∫•t c·∫£ ƒë·ªôi tr∆∞·ªüng</option>';
        Array.from(tendtSet).sort().forEach(tendt => {
          tendtFilter.innerHTML += `<option value="${tendt}">${tendt}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc l√¥
      const tenloFilter = document.getElementById('tenloFilter');
      if (tenloFilter) {
        tenloFilter.innerHTML = '<option value="">T·∫•t c·∫£ l√¥</option>';
        Array.from(tenloSet).sort().forEach(tenlo => {
          tenloFilter.innerHTML += `<option value="${tenlo}">${tenlo}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc t·ªï tr∆∞·ªüng
      const tenttFilter = document.getElementById('tenttFilter');
      if (tenttFilter) {
        tenttFilter.innerHTML = '<option value="">T·∫•t c·∫£ t·ªï tr∆∞·ªüng</option>';
        Array.from(tenttSet).sort().forEach(tentt => {
          tenttFilter.innerHTML += `<option value="${tentt}">${tentt}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc c√¥ng nh√¢n
      const cnFilter = document.getElementById('cnFilter');
      if (cnFilter) {
        cnFilter.innerHTML = '<option value="">T·∫•t c·∫£ c√¥ng nh√¢n</option>';
        Array.from(cnSet).sort().forEach(cn => {
          cnFilter.innerHTML += `<option value="${cn}">${cn}</option>`;
        });
      }

      // C·∫≠p nh·∫≠t b·ªô l·ªçc t√¨nh tr·∫°ng b·ªánh
      const diseaseFilter = document.getElementById('diseaseFilter');
      if (diseaseFilter) {
        diseaseFilter.innerHTML = '<option value="">T·∫•t c·∫£ t√¨nh tr·∫°ng b·ªánh</option>';
        Array.from(diseaseSet).sort().forEach(disease => {
          diseaseFilter.innerHTML += `<option value="${disease}">${disease}</option>`;
        });
      }
    }

    // H√†m format ng√†y th√°ng t·ª´ Excel
    function formatDateFromExcel(dateValue) {
      if (!dateValue) return '';
      
      console.log('formatDateFromExcel input:', { dateValue, type: typeof dateValue });
      
      // N·∫øu l√† s·ªë (serial date c·ªßa Excel)
      if (typeof dateValue === 'number') {
        // Excel serial date b·∫Øt ƒë·∫ßu t·ª´ 1900-01-01
        const excelEpoch = new Date(1900, 0, 1);
        const date = new Date(excelEpoch.getTime() + (dateValue - 2) * 24 * 60 * 60 * 1000);
        const result = formatDate(date);
        console.log('Excel serial date converted:', { dateValue, result });
        return result;
      }
      
      // N·∫øu l√† string, th·ª≠ parse
      if (typeof dateValue === 'string') {
        // Th·ª≠ parse c√°c ƒë·ªãnh d·∫°ng kh√°c nhau
        let date;
        
        // Th·ª≠ ƒë·ªãnh d·∫°ng dd/mm/yyyy
        if (dateValue.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
          const parts = dateValue.split('/');
          date = new Date(parts[2], parts[1] - 1, parts[0]);
        }
        // Th·ª≠ ƒë·ªãnh d·∫°ng yyyy-mm-dd
        else if (dateValue.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          date = new Date(dateValue);
        }
        // Th·ª≠ parse th√¥ng th∆∞·ªùng
        else {
          date = new Date(dateValue);
        }
        
        if (!isNaN(date.getTime())) {
          const result = formatDate(date);
          console.log('String date converted:', { dateValue, result });
          return result;
        }
        // N·∫øu kh√¥ng parse ƒë∆∞·ª£c, tr·∫£ v·ªÅ nguy√™n g·ªëc
        console.log('String date not parsed, returning original:', dateValue);
        return dateValue;
      }
      
      // N·∫øu l√† Date object
      if (dateValue instanceof Date) {
        const result = formatDate(dateValue);
        console.log('Date object converted:', { dateValue, result });
        return result;
      }
      
      console.log('Unknown type, returning toString:', dateValue);
      return dateValue.toString();
    }
    
    // H√†m format ng√†y th√†nh dd/mm/yyyy
    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }
    
    // H√†m format ng√†y cho input type="date" (yyyy-mm-dd)
    function formatDateForInput(dateValue) {
      if (!dateValue) return '';
      
      let date;
      if (typeof dateValue === 'number') {
        // Excel serial date
        const excelEpoch = new Date(1900, 0, 1);
        date = new Date(excelEpoch.getTime() + (dateValue - 2) * 24 * 60 * 60 * 1000);
      } else if (typeof dateValue === 'string') {
        // Th·ª≠ parse c√°c ƒë·ªãnh d·∫°ng kh√°c nhau
        if (dateValue.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
          const parts = dateValue.split('/');
          date = new Date(parts[2], parts[1] - 1, parts[0]);
        } else if (dateValue.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
          date = new Date(dateValue);
        } else {
          date = new Date(dateValue);
        }
      } else if (dateValue instanceof Date) {
        date = dateValue;
      } else {
        return '';
      }
      
      if (!date || isNaN(date.getTime())) return '';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // H√†m t√¨m ki·∫øm ID ri√™ng bi·ªát
    function searchById() {
      const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
      
      if (!searchTerm) {
        // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a t√¨m ki·∫øm, hi·ªÉn th·ªã t·∫•t c·∫£ markers
        markers.forEach(marker => {
          marker.setStyle({ 
            radius: 10, 
            opacity: 1, 
            fillOpacity: 0.8, 
            weight: 2,
            color: marker.treeData.markerColor,
            fillColor: marker.treeData.markerColor
          });
        });
        return;
      }
      
      let foundMarkers = [];
      
      markers.forEach(marker => {
        const data = marker.treeData;
        // T√¨m ki·∫øm trong c·ªôt ID (h·ªó tr·ª£ c·∫£ id v√† ID)
        const markerId = (data.id || '').toString().toLowerCase();
        const isMatch = markerId.includes(searchTerm);
        
        if (isMatch) {
          // L√†m n·ªïi b·∫≠t c√¢y t√¨m th·∫•y
          marker.setStyle({ 
            radius: Math.max(getRadiusForZoom(map.getZoom()) + 6, 10), 
            opacity: 1, 
            fillOpacity: 1, 
            weight: 4,
            color: '#ff0000',
            fillColor: '#ff0000'
          });
          foundMarkers.push(marker);
        } else {
          // L√†m m·ªù c√°c c√¢y kh√°c (70% m·ªù)
          marker.setStyle({ 
            radius: Math.max(1.5, getRadiusForZoom(map.getZoom()) - 2), 
            opacity: 0.3, 
            fillOpacity: 0.3, 
            weight: 1,
            color: data.markerColor,
            fillColor: data.markerColor
          });
        }
      });
      
      // N·∫øu t√¨m th·∫•y c√¢y, zoom ƒë·∫øn v·ªã tr√≠ v√† m·ªü popup
      if (foundMarkers.length > 0) {
        const firstMarker = foundMarkers[0];
        const data = firstMarker.treeData;
        map.setView([data.lat, data.lon], 18);
        firstMarker.openPopup();
        
        // C·∫≠p nh·∫≠t status bar
        if (foundMarkers.length === 1) {
          document.getElementById('statusBar').textContent = 
            `T√¨m th·∫•y: ${data.id} | T·ªça ƒë·ªô: ${data.lat.toFixed(6)}, ${data.lon.toFixed(6)} | Zoom: 18`;
        } else {
          document.getElementById('statusBar').textContent = 
            `T√¨m th·∫•y ${foundMarkers.length} c√¢y c√≥ ID ch·ª©a "${searchTerm}" | T·ªça ƒë·ªô: ${data.lat.toFixed(6)}, ${data.lon.toFixed(6)} | Zoom: 18`;
        }
      } else {
        // C·∫≠p nh·∫≠t status bar khi kh√¥ng t√¨m th·∫•y
        document.getElementById('statusBar').textContent = 
          `Kh√¥ng t√¨m th·∫•y ID: "${searchTerm}" | T·ªça ƒë·ªô: -- | Zoom: --`;
      }
      
      // C·∫≠p nh·∫≠t th·ªëng k√™ d·ªØ li·ªáu d·ª±a tr√™n k·∫øt qu·∫£ t√¨m ki·∫øm
      if (searchTerm) {
        const searchResults = foundMarkers.map(marker => marker.treeData);
        console.log('C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ t√¨m ki·∫øm:', searchResults.length, 'items');
        updateDataStatsPanel(searchResults);
      } else {
        // Khi kh√¥ng c√≥ t√¨m ki·∫øm, hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l·ªçc
        const filteredData = getFilteredData();
        console.log('C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ d·ªØ li·ªáu ƒë√£ l·ªçc:', filteredData.length, 'items');
        updateDataStatsPanel(filteredData);
      }
      
      // Kh√¥ng m·ªü b·∫£ng chi ti·∫øt
    }
    
    // H√†m x√≥a t√¨m ki·∫øm
    function clearSearch() {
      document.getElementById('searchBox').value = '';
      searchById(); // G·ªçi l·∫°i ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£ markers
      updateFilterStatsPanel();
      // Kh√¥ng c·∫ßn g·ªçi updateDataStatsPanel ·ªü ƒë√¢y v√¨ searchById() ƒë√£ g·ªçi r·ªìi
    }

    function filterMarkers() {
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const yearFilter = document.getElementById('yearFilter').value;
      const tenntFilter = document.getElementById('tenntFilter').value;
      const tendoiFilter = document.getElementById('tendoiFilter').value;
      const tendtFilter = document.getElementById('tendtFilter').value;
      const tenloFilter = document.getElementById('tenloFilter').value;
      const tenttFilter = document.getElementById('tenttFilter').value;
      const cnFilter = document.getElementById('cnFilter').value;
      const diseaseFilter = document.getElementById('diseaseFilter').value;

      console.log('B·ªô l·ªçc hi·ªán t·∫°i:', {
        tennt: tenntFilter,
        tendoi: tendoiFilter,
        tendt: tendtFilter,
        tenlo: tenloFilter,
        tentt: tenttFilter,
        cn: cnFilter
      });

      // Ki·ªÉm tra xem c√≥ ƒëang l·ªçc theo ch·∫•t l∆∞·ª£ng kh√¥ng
      const isFilteringByStatus = statusFilter !== '';
      let visibleCount = 0;

      const visibleItems = [];
      markers.forEach(marker => {
        const data = marker.treeData;
        const matchesStatus = !statusFilter || data.chatLuong === statusFilter;
        const matchesType = !typeFilter || data.ten === typeFilter;
        const matchesYear = !yearFilter || (data.namTrong && parseInt(data.namTrong) === parseInt(yearFilter));
        const matchesTennt = !tenntFilter || data.tennt === tenntFilter;
        
        // Debug cho tennt filter
        if (tenntFilter) {
          console.log(`Ki·ªÉm tra tennt: filter="${tenntFilter}", data.tennt="${data.tennt}", match=${matchesTennt}`);
        }
        const matchesTendoi = !tendoiFilter || data.tendoi === tendoiFilter;
        const matchesTendt = !tendtFilter || data.tendt === tendtFilter;
        const matchesTenlo = !tenloFilter || data.tenlo === tenloFilter;
        const matchesTentt = !tenttFilter || data.tentt === tenttFilter;
        const matchesCn = !cnFilter || data.cn === cnFilter;
        const matchesDisease = !diseaseFilter || data.tinhtrangbenh === diseaseFilter;
        
        const isVisible = matchesStatus && matchesType && matchesYear && matchesTennt && matchesTendoi && matchesTendt && matchesTenlo && matchesTentt && matchesCn && matchesDisease;
        
        if (isVisible) visibleCount++;
        if (isVisible) visibleItems.push(data);
        
        // X√°c ƒë·ªãnh m√†u s·∫Øc hi·ªÉn th·ªã
        let displayColor = data.markerColor; // M·∫∑c ƒë·ªãnh l√† m√†u c·ªßa t√™n c√¢y
        
        // N·∫øu ƒëang l·ªçc theo ch·∫•t l∆∞·ª£ng, hi·ªÉn th·ªã m√†u c·ªßa ch·∫•t l∆∞·ª£ng
        if (isFilteringByStatus && data.mau) {
          displayColor = data.mau.toLowerCase();
        }
        
        if (isVisible) {
          marker.setStyle({ 
            radius: getRadiusForZoom(map.getZoom()), 
            opacity: 1, 
            fillOpacity: 0.8, 
            weight: 2,
            color: displayColor,
            fillColor: displayColor
          });
        } else {
          marker.setStyle({ 
            radius: Math.max(0.1, getRadiusForZoom(map.getZoom()) * 0.6), 
            opacity: 0.3, 
            fillOpacity: 0.2, 
            weight: 1,
            color: displayColor,
            fillColor: displayColor
          });
        }
      });

      // C·∫≠p nh·∫≠t th·ªëng k√™ v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
      updateFilteredStats(visibleCount);
      
      // C·∫≠p nh·∫≠t b·∫£ng ch√∫ gi·∫£i theo m√†u s·∫Øc hi·ªÉn th·ªã
      updateLegendAfterFilter(isFilteringByStatus);
      
      // C·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™ theo b·ªô l·ªçc
      updateFilterStatsPanel();

    }

    function updateFilteredStats(visibleCount) {
      // C·∫≠p nh·∫≠t th·ªëng k√™ v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
      // ƒê·ªìng b·ªô v·ªõi b·∫£ng chi ti·∫øt: n·∫øu opacity ch∆∞a ƒë·∫∑t th√¨ coi nh∆∞ hi·ªÉn th·ªã
      const visibleMarkers = markers.filter(marker =>
        marker.options.opacity === undefined || marker.options.opacity > 0.5
      );
      
      let chatLuongStats = {};
      let loaiCayStats = {};
      let tenntStats = {};
      let tengdStats = {};
      let tendoiStats = {};
      let tendtStats = {};
      let tenloStats = {};
      let tenttStats = {};
      let cnStats = {};
      
      visibleMarkers.forEach(marker => {
        const data = marker.treeData;
        
        // Th·ªëng k√™ ch·∫•t l∆∞·ª£ng
        if (data.chatLuong) {
          chatLuongStats[data.chatLuong] = (chatLuongStats[data.chatLuong] || 0) + 1;
        }
        
        // Th·ªëng k√™ lo·∫°i c√¢y
        if (data.ten) {
          loaiCayStats[data.ten] = (loaiCayStats[data.ten] || 0) + 1;
        }
        
        // Th·ªëng k√™ n√¥ng tr∆∞·ªùng
        if (data.tennt) {
          tenntStats[data.tennt] = (tenntStats[data.tennt] || 0) + 1;
        }
        
        // Th·ªëng k√™ gi√°m ƒë·ªëc
        if (data.tengd) {
          tengdStats[data.tengd] = (tengdStats[data.tengd] || 0) + 1;
        }
        
        // Th·ªëng k√™ ƒë·ªôi
        if (data.tendoi) {
          tendoiStats[data.tendoi] = (tendoiStats[data.tendoi] || 0) + 1;
        }
        
        // Th·ªëng k√™ ƒë·ªôi tr∆∞·ªüng
        if (data.tendt) {
          tendtStats[data.tendt] = (tendtStats[data.tendt] || 0) + 1;
        }
        
        // Th·ªëng k√™ l√¥
        if (data.tenlo) {
          tenloStats[data.tenlo] = (tenloStats[data.tenlo] || 0) + 1;
        }
        
        // Th·ªëng k√™ th·ª≠a
        if (data.tentt) {
          tenttStats[data.tentt] = (tenttStats[data.tentt] || 0) + 1;
        }
        
        // Th·ªëng k√™ c√¥ng nh√¢n
        if (data.cn) {
          cnStats[data.cn] = (cnStats[data.cn] || 0) + 1;
        }
      });
      
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªëng k√™
      console.log('C·∫≠p nh·∫≠t th·ªëng k√™ l·ªçc:', { 
        visibleCount, 
        visibleMarkers: visibleMarkers.length,
        tenntStats, 
        tengdStats,
        chatLuongStats,
        loaiCayStats
      });
      updateStats(visibleCount, chatLuongStats, loaiCayStats, {});
      updateManagementStatsFiltered(tenntStats, tengdStats, tendoiStats, tendtStats, tenloStats, tenttStats, cnStats, visibleCount);
      
      // S·ª≠ d·ª•ng h√†m getFilteredData ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n
      const filteredData = getFilteredData();
      console.log('G·ªçi updateDataStatsPanel v·ªõi filteredData:', filteredData.length, 'items');
      updateDataStatsPanel(filteredData);
    }

    function updateManagementStatsFiltered(tenntStats, tengdStats, tendoiStats, tendtStats, tenloStats, tenttStats, cnStats, totalCount) {
      let html = '';

      // Hi·ªÉn th·ªã th√¥ng tin l·ªçc hi·ªán t·∫°i
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const yearFilter = document.getElementById('yearFilter').value;
      const tenntFilter = document.getElementById('tenntFilter').value;
      const tendoiFilter = document.getElementById('tendoiFilter').value;
      const tendtFilter = document.getElementById('tendtFilter').value;
      const tenloFilter = document.getElementById('tenloFilter').value;
      const tenttFilter = document.getElementById('tenttFilter').value;
      const cnFilter = document.getElementById('cnFilter').value;

      console.log('updateManagementStatsFiltered ƒë∆∞·ª£c g·ªçi v·ªõi:', { 
        totalCount, 
        tenntStats, 
        tengdStats, 
        filters: { statusFilter, typeFilter, yearFilter, tenntFilter, tendoiFilter, tendtFilter, tenloFilter, tenttFilter, cnFilter }
      });

      // Ki·ªÉm tra xem c√≥ ƒëang l·ªçc kh√¥ng
      const hasFilter = statusFilter || typeFilter || yearFilter || tenntFilter || tendoiFilter || tendtFilter || tenloFilter || tenttFilter || cnFilter;
      
      console.log('Ki·ªÉm tra hasFilter:', { 
        hasFilter, 
        statusFilter, 
        typeFilter, 
        yearFilter, 
        tenntFilter, 
        tendoiFilter, 
        tendtFilter, 
        tenloFilter, 
        tenttFilter, 
        cnFilter 
      });
      
      if (hasFilter) {
        html += `<div style="margin-bottom: 8px; padding: 8px; background: #e8f4fd; border: 2px solid #bee5eb; border-radius: 6px; font-size: 10px;">
          <strong style="color: #0c5460; font-size: 11px;">üîç B·ªô l·ªçc hi·ªán t·∫°i (${totalCount} c√¢y):</strong><br/>`;
        
        if (statusFilter) html += `‚Ä¢ Ch·∫•t l∆∞·ª£ng: <span style="color: #27ae60; font-weight: bold;">${statusFilter}</span><br/>`;
        if (typeFilter) html += `‚Ä¢ Lo·∫°i c√¢y: <span style="color: #27ae60; font-weight: bold;">${typeFilter}</span><br/>`;
        if (yearFilter) html += `‚Ä¢ NƒÉm: <span style="color: #27ae60; font-weight: bold;">${yearFilter}</span><br/>`;
        if (tenntFilter) html += `‚Ä¢ N√¥ng tr∆∞·ªùng: <span style="color: #27ae60; font-weight: bold;">${tenntFilter}</span><br/>`;
        if (tendoiFilter) html += `‚Ä¢ ƒê·ªôi: <span style="color: #27ae60; font-weight: bold;">${tendoiFilter}</span><br/>`;
        if (tendtFilter) html += `‚Ä¢ ƒê·ªôi tr∆∞·ªüng: <span style="color: #27ae60; font-weight: bold;">${tendtFilter}</span><br/>`;
        if (tenloFilter) html += `‚Ä¢ L√¥: <span style="color: #27ae60; font-weight: bold;">${tenloFilter}</span><br/>`;
        if (tenttFilter) html += `‚Ä¢ T·ªï tr∆∞·ªüng: <span style="color: #27ae60; font-weight: bold;">${tenttFilter}</span><br/>`;
        if (cnFilter) html += `‚Ä¢ C√¥ng nh√¢n: <span style="color: #27ae60; font-weight: bold;">${cnFilter}</span><br/>`;
        
        html += `</div>`;
        
        // ƒê√£ b·ªè panel th·ªëng k√™ khi c√≥ l·ªçc
      } else {
        html += `<div style="margin-bottom: 8px; padding: 6px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 9px; color: #6c757d;">
          üìä Hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu (${totalCount} c√¢y)
        </div>`;
      }


      // Th·ªëng k√™ n√¥ng tr∆∞·ªùng
      if (Object.keys(tenntStats).length > 0) {
        html += `<div style="margin-bottom: 6px; font-size: 9px;"><strong>üè≠ N√¥ng tr∆∞·ªùng (${totalCount} c√¢y):</strong></div>`;
        Object.entries(tenntStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tennt, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tennt}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ gi√°m ƒë·ªëc
      if (Object.keys(tengdStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë®‚Äçüíº Gi√°m ƒë·ªëc:</strong></div>`;
        Object.entries(tengdStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tengd, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tengd}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ ƒë·ªôi
      if (Object.keys(tendoiStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë• ƒê·ªôi:</strong></div>`;
        Object.entries(tendoiStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tendoi, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tendoi}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ ƒë·ªôi tr∆∞·ªüng
      if (Object.keys(tendtStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë®‚Äçüíº ƒê·ªôi tr∆∞·ªüng:</strong></div>`;
        Object.entries(tendtStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tendt, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tendt}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ l√¥
      if (Object.keys(tenloStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üì¶ L√¥:</strong></div>`;
        Object.entries(tenloStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tenlo, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tenlo}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ t·ªï tr∆∞·ªüng
      if (Object.keys(tenttStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë®‚Äçüíº T·ªï tr∆∞·ªüng:</strong></div>`;
        Object.entries(tenttStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tentt, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tentt}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ c√¥ng nh√¢n
      if (Object.keys(cnStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë∑ C√¥ng nh√¢n:</strong></div>`;
        Object.entries(cnStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([cn, count]) => {
            const pct = ((count/totalCount)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${cn}: ${count} (${pct}%)</div>`;
          });
      }

      if (html === '') {
        html = '<div style="font-size: 8px; color: #7f8c8d;">Kh√¥ng c√≥ th√¥ng tin qu·∫£n l√Ω</div>';
      }

      console.log('HTML ƒë∆∞·ª£c t·∫°o ra:', html);
      const mgmtEl = document.getElementById('managementStatsContent');
      if (mgmtEl) { 
        mgmtEl.innerHTML = html; 
      } else {
        console.warn('Element managementStatsContent kh√¥ng t·ªìn t·∫°i');
      }
    }

    function updateLegendAfterFilter(isFilteringByStatus) {
      // legend removed
    }

    function clearFilters() {
      document.getElementById('statusFilter').value = '';
      document.getElementById('typeFilter').value = '';
      document.getElementById('yearFilter').value = '';
      document.getElementById('tenntFilter').value = '';
      document.getElementById('tendoiFilter').value = '';
      document.getElementById('tendtFilter').value = '';
      document.getElementById('tenloFilter').value = '';
      document.getElementById('tenttFilter').value = '';
      document.getElementById('cnFilter').value = '';
      document.getElementById('diseaseFilter').value = '';
      filterMarkers();
      
      // C·∫≠p nh·∫≠t l·∫°i th·ªëng k√™ ban ƒë·∫ßu
      let tong = 0;
      let chatLuongStats = {};
      let loaiCayStats = {};
      let colorStats = {};
      
      markers.forEach(marker => {
        const data = marker.treeData;
        chatLuongStats[data.chatLuong] = (chatLuongStats[data.chatLuong] || 0) + 1;
        loaiCayStats[data.ten] = (loaiCayStats[data.ten] || 0) + 1;
        colorStats[data.markerColor] = (colorStats[data.markerColor] || 0) + 1;
        tong++;
      });
      
      updateStats(tong, chatLuongStats, loaiCayStats, colorStats);
      
      // T√≠nh to√°n th·ªëng k√™ qu·∫£n l√Ω t·ª´ t·∫•t c·∫£ d·ªØ li·ªáu
      let tenntStats = {};
      let tengdStats = {};
      let tendoiStats = {};
      let tendtStats = {};
      let tenloStats = {};
      let tenttStats = {};
      let cnStats = {};
      
      allTreeData.forEach(row => {
        const tennt = (row.tennt || '').trim();
        const tengd = (row.tengd || '').trim();
        const tendoi = (row.tendoi || '').trim();
        const tendt = (row.tendt || '').trim();
        const tenlo = (row.tenlo || '').trim();
        const tentt = (row.tentt || '').trim();
        const cn = (row.cn || '').trim();

        if (tennt) tenntStats[tennt] = (tenntStats[tennt] || 0) + 1;
        if (tengd) tengdStats[tengd] = (tengdStats[tengd] || 0) + 1;
        if (tendoi) tendoiStats[tendoi] = (tendoiStats[tendoi] || 0) + 1;
        if (tendt) tendtStats[tendt] = (tendtStats[tendt] || 0) + 1;
        if (tenlo) tenloStats[tenlo] = (tenloStats[tenlo] || 0) + 1;
        if (tentt) tenttStats[tentt] = (tenttStats[tentt] || 0) + 1;
        if (cn) cnStats[cn] = (cnStats[cn] || 0) + 1;
      });
      
      updateManagementStatsFiltered(tenntStats, tengdStats, tendoiStats, tendtStats, tenloStats, tenttStats, cnStats, tong);
      
      // C·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™ d·ªØ li·ªáu t·ª´ t·∫•t c·∫£ markers (sau khi x√≥a l·ªçc)
      const allMarkersData = markers.map(marker => marker.treeData);
      console.log('C·∫≠p nh·∫≠t th·ªëng k√™ sau khi x√≥a l·ªçc:', allMarkersData.length, 'items');
      updateDataStatsPanel(allMarkersData);
      
      // ƒê√£ b·ªè panel th·ªëng k√™ khi x√≥a l·ªçc
      
      // C·∫≠p nh·∫≠t b·∫£ng ch√∫ gi·∫£i sau khi x√≥a l·ªçc
      updateLegendAfterFilter(false);
      
      // B·ªè c·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p
    }

    function updateStats(tong, chatLuongStats, loaiCayStats, colorStats) {
      let html = `<div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">üå≥ T·ªïng s·ªë c√¢y: ${tong}</div>`;

      html += `<div style="margin-bottom: 8px;"><strong>üìå Ch·∫•t l∆∞·ª£ng:</strong></div>`;
      for (let k in chatLuongStats) {
        const pct = ((chatLuongStats[k]/tong)*100).toFixed(1);
        html += `<div style="margin-left: 10px; font-size: 12px;">‚Ä¢ ${k}: ${chatLuongStats[k]} (${pct}%)</div>`;
      }

      html += `<div style="margin: 8px 0;"><strong>üå± Lo·∫°i c√¢y:</strong></div>`;
      for (let k in loaiCayStats) {
        const pct = ((loaiCayStats[k]/tong)*100).toFixed(1);
        html += `<div style="margin-left: 10px; font-size: 12px;">‚Ä¢ ${k}: ${loaiCayStats[k]} (${pct}%)</div>`;
      }

      const statsEl = document.getElementById('statsContent');
      if (statsEl) { 
        statsEl.innerHTML = html; 
      } else {
        console.warn('Element statsContent kh√¥ng t·ªìn t·∫°i');
      }
    }

    function updateManagementStats(data) {
      const tenntStats = {};
      const tengdStats = {};
      const tendoiStats = {};
      const tendtStats = {};
      const tenloStats = {};
      const tenttStats = {};
      const cnStats = {};

      data.forEach(row => {
        const tennt = (row.tennt || '').trim();
        const tengd = (row.tengd || '').trim();
        const tendoi = (row.tendoi || '').trim();
        const tendt = (row.tendt || '').trim();
        const tenlo = (row.tenlo || '').trim();
        const tentt = (row.tentt || '').trim();
        const cn = (row.cn || '').trim();

        if (tennt) tenntStats[tennt] = (tenntStats[tennt] || 0) + 1;
        if (tengd) tengdStats[tengd] = (tengdStats[tengd] || 0) + 1;
        if (tendoi) tendoiStats[tendoi] = (tendoiStats[tendoi] || 0) + 1;
        if (tendt) tendtStats[tendt] = (tendtStats[tendt] || 0) + 1;
        if (tenlo) tenloStats[tenlo] = (tenloStats[tenlo] || 0) + 1;
        if (tentt) tenttStats[tentt] = (tenttStats[tentt] || 0) + 1;
        if (cn) cnStats[cn] = (cnStats[cn] || 0) + 1;
      });

      let html = '';

      // Th·ªëng k√™ n√¥ng tr∆∞·ªùng
      if (Object.keys(tenntStats).length > 0) {
        html += `<div style="margin-bottom: 6px; font-size: 9px;"><strong>üè≠ N√¥ng tr∆∞·ªùng:</strong></div>`;
        Object.entries(tenntStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tennt, count]) => {
            const pct = ((count/data.length)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tennt}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ gi√°m ƒë·ªëc
      if (Object.keys(tengdStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë®‚Äçüíº Gi√°m ƒë·ªëc:</strong></div>`;
        Object.entries(tengdStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tengd, count]) => {
            const pct = ((count/data.length)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tengd}: ${count} (${pct}%)</div>`;
          });
      }


      // Th·ªëng k√™ ƒë·ªôi
      if (Object.keys(tendoiStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë• ƒê·ªôi:</strong></div>`;
        Object.entries(tendoiStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tendoi, count]) => {
            const pct = ((count/data.length)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tendoi}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ l√¥
      if (Object.keys(tenloStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üì¶ L√¥:</strong></div>`;
        Object.entries(tenloStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tenlo, count]) => {
            const pct = ((count/data.length)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tenlo}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ t·ªï tr∆∞·ªüng
      if (Object.keys(tenttStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë®‚Äçüíº T·ªï tr∆∞·ªüng:</strong></div>`;
        Object.entries(tenttStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([tentt, count]) => {
            const pct = ((count/data.length)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${tentt}: ${count} (${pct}%)</div>`;
          });
      }

      // Th·ªëng k√™ c√¥ng nh√¢n
      if (Object.keys(cnStats).length > 0) {
        html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üë∑ C√¥ng nh√¢n:</strong></div>`;
        Object.entries(cnStats)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5)
          .forEach(([cn, count]) => {
            const pct = ((count/data.length)*100).toFixed(1);
            html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${cn}: ${count} (${pct}%)</div>`;
          });
      }

      if (html === '') {
        html = '<div style="font-size: 8px; color: #7f8c8d;">Kh√¥ng c√≥ th√¥ng tin qu·∫£n l√Ω</div>';
      }

      const mgmtEl2 = document.getElementById('managementStatsContent');
      if (mgmtEl2) { 
        mgmtEl2.innerHTML = html; 
      } else {
        console.warn('Element managementStatsContent kh√¥ng t·ªìn t·∫°i');
      }
    }

    function updateDataStatsPanel(data) {
      console.log('updateDataStatsPanel ƒë∆∞·ª£c g·ªçi v·ªõi data:', data);
      if (!data || data.length === 0) {
        const totalTreesEl = document.getElementById('totalTrees');
        const editedTreesEl = document.getElementById('editedTrees');
        const goodQualityEl = document.getElementById('goodQuality');
        const mediumQualityEl = document.getElementById('mediumQuality');
        const poorQualityEl = document.getElementById('poorQuality');
        const commonTypeEl = document.getElementById('commonType');
        
        if (totalTreesEl) totalTreesEl.textContent = '0';
        if (editedTreesEl) editedTreesEl.textContent = '0';
        if (goodQualityEl) goodQualityEl.textContent = '0';
        if (mediumQualityEl) mediumQualityEl.textContent = '0';
        if (poorQualityEl) poorQualityEl.textContent = '0';
        if (commonTypeEl) commonTypeEl.textContent = '-';
        return;
      }

      // ƒê·∫øm t·ªïng s·ªë c√¢y
      const totalTrees = data.length;
      
      // ƒê·∫øm s·ªë c√¢y ƒë√£ ch·ªânh s·ª≠a t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i
      let editedTrees = 0;
      data.forEach((row, index) => {
        // X·ª≠ l√Ω c·∫£ hai c·∫•u tr√∫c: row.id (t·ª´ Excel) v√† row.id (t·ª´ marker.treeData)
        const rowId = (row.id || row.ID || row.Id || '').toString().trim();
        if (editedTreesList.has(rowId)) {
          editedTrees++;
        }
        
        // Debug: Log m·ªôt v√†i item ƒë·ªÉ ki·ªÉm tra ID
        if (index < 3) {
          console.log(`Edited check ${index}:`, {
            rowId: rowId,
            inEditedList: editedTreesList.has(rowId),
            editedTreesListSize: editedTreesList.size
          });
        }
      });
      
      // Th·ªëng k√™ ch·∫•t l∆∞·ª£ng
      const qualityStats = {};
      const typeStats = {};
      
      data.forEach((row, index) => {
        // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ marker.treeData (c√≥ c·∫•u tr√∫c kh√°c v·ªõi Excel)
        const chatLuong = (row.chatLuong || row.chat_luong || '').toString().toLowerCase();
        const ten = (row.ten || '').toString().trim();
        
        // Debug: Log m·ªôt v√†i item ƒë·∫ßu ti√™n ƒë·ªÉ ki·ªÉm tra
        if (index < 3) {
          console.log(`Item ${index}:`, {
            id: row.id,
            ten: ten,
            chatLuong: chatLuong,
            originalChatLuong: row.chatLuong || row.chat_luong
          });
        }
        
        // Ph√¢n lo·∫°i ch·∫•t l∆∞·ª£ng
        if (chatLuong.includes('t·ªët') || chatLuong.includes('excellent')) {
          qualityStats.tot = (qualityStats.tot || 0) + 1;
        } else if (chatLuong.includes('trung b√¨nh') || chatLuong.includes('good') || chatLuong.includes('kh√°')) {
          qualityStats.trungBinh = (qualityStats.trungBinh || 0) + 1;
        } else if (chatLuong.includes('x·∫•u') || chatLuong.includes('poor') || chatLuong.includes('k√©m')) {
          qualityStats.kem = (qualityStats.kem || 0) + 1;
        }
        
        // Th·ªëng k√™ lo·∫°i c√¢y
        if (ten) {
          typeStats[ten] = (typeStats[ten] || 0) + 1;
        }
      });
      
      // Th·ªëng k√™ d·ªãch b·ªánh v√† nƒÉm tr·ªìng, qu·∫£n l√Ω
      const diseaseStats = {};
      let diseased = 0, healthy = 0, unknownDisease = 0;
      const yearStats = {};
      const farmStats = {}, teamStats = {}, lotStats = {}, workerStats = {};

      data.forEach(row => {
        const diseaseRaw = (row.tinhtrangbenh || row.disease || '').toString().trim();
        const diseaseNorm = diseaseRaw.toLowerCase();
        const isUnknown = diseaseNorm === '' || diseaseNorm === '-' || diseaseNorm === 'n/a' || diseaseNorm === 'na' || diseaseNorm === 'null';
        const isHealthy =
          diseaseNorm.includes('kh·ªèe') ||
          diseaseNorm.includes('khoe') ||
          diseaseNorm.includes('healthy') ||
          diseaseNorm.includes('kh√¥ng b·ªánh') ||
          diseaseNorm.includes('khong benh') ||
          diseaseNorm.includes('kh√¥ng c√≥ b·ªánh') ||
          diseaseNorm.includes('khong co benh') ||
          diseaseNorm.includes('kh√¥ng b·ªã b·ªánh') ||
          diseaseNorm.includes('khong bi benh');

        if (isUnknown) {
          unknownDisease++;
        } else if (isHealthy) {
          healthy++;
        } else {
          diseased++;
          diseaseStats[diseaseRaw] = (diseaseStats[diseaseRaw] || 0) + 1;
        }

        const year = (row.namTrong || row.year || '').toString().trim();
        if (year) {
          yearStats[year] = (yearStats[year] || 0) + 1;
        }

        const farm = (row.tennt || '').toString().trim();
        const team = (row.tendoi || '').toString().trim();
        const lot = (row.tenlo || '').toString().trim();
        const worker = (row.cn || '').toString().trim();
        if (farm) farmStats[farm] = (farmStats[farm] || 0) + 1;
        if (team) teamStats[team] = (teamStats[team] || 0) + 1;
        if (lot) lotStats[lot] = (lotStats[lot] || 0) + 1;
        if (worker) workerStats[worker] = (workerStats[worker] || 0) + 1;
      });

      // T√¨m lo·∫°i c√¢y ph·ªï bi·∫øn nh·∫•t
      let commonType = '-';
      if (Object.keys(typeStats).length > 0) {
        const sortedTypes = Object.entries(typeStats).sort(([,a], [,b]) => b - a);
        commonType = sortedTypes[0][0];
      }
      
      // C·∫≠p nh·∫≠t giao di·ªán
      console.log('C·∫≠p nh·∫≠t th·ªëng k√™:', {
        totalTrees,
        editedTrees,
        qualityStats,
        typeStats,
        commonType,
        dataLength: data.length
      });
      
      // Ki·ªÉm tra xem c√°c element c√≥ t·ªìn t·∫°i kh√¥ng
      const totalTreesEl = document.getElementById('totalTrees');
      const editedTreesEl = document.getElementById('editedTrees');
      const goodQualityEl = document.getElementById('goodQuality');
      const mediumQualityEl = document.getElementById('mediumQuality');
      const poorQualityEl = document.getElementById('poorQuality');
      const commonTypeEl = document.getElementById('commonType');
      const totalQualityTreesEl = document.getElementById('totalQualityTrees');
      const goodQualityPercentEl = document.getElementById('goodQualityPercent');
      const mediumQualityPercentEl = document.getElementById('mediumQualityPercent');
      const poorQualityPercentEl = document.getElementById('poorQualityPercent');
      
      if (totalTreesEl) totalTreesEl.textContent = totalTrees;
      if (editedTreesEl) editedTreesEl.textContent = editedTrees;
      const goodCnt = qualityStats.tot || 0;
      const medCnt = qualityStats.trungBinh || 0;
      const poorCnt = qualityStats.kem || 0;
      const totalQl = goodCnt + medCnt + poorCnt;
      if (goodQualityEl) goodQualityEl.textContent = `${goodCnt} c√¢y`;
      if (mediumQualityEl) mediumQualityEl.textContent = `${medCnt} c√¢y`;
      if (poorQualityEl) poorQualityEl.textContent = `${poorCnt} c√¢y`;
      if (totalQualityTreesEl) totalQualityTreesEl.textContent = `${totalQl} c√¢y`;
      // C·∫≠p nh·∫≠t t·ª∑ l·ªá, b·∫£o ƒë·∫£m kh√¥ng NaN khi kh√¥ng c√≥ d·ªØ li·ªáu
      const pct = (n, d) => (d > 0 ? ((n / d) * 100).toFixed(1) : '0.0');
      if (goodQualityPercentEl) goodQualityPercentEl.textContent = `${pct(goodCnt, totalQl)}%`;
      if (mediumQualityPercentEl) mediumQualityPercentEl.textContent = `${pct(medCnt, totalQl)}%`;
      if (poorQualityPercentEl) poorQualityPercentEl.textContent = `${pct(poorCnt, totalQl)}%`;
      if (commonTypeEl) commonTypeEl.textContent = commonType;
      
      // C·∫≠p nh·∫≠t "üå≥ Theo ch·ªßng lo·∫°i" (th·ªëng k√™ theo tr∆∞·ªùng ten)
      const treeTypesDetailEl = document.getElementById('treeTypesDetail');
      if (treeTypesDetailEl) {
        const total = totalTrees || 0;
        const typesSortedAZ = Object.entries(typeStats).sort((a,b) => a[0].localeCompare(b[0]));
        const totalDistinct = typesSortedAZ.length;
        const rows = typesSortedAZ.map(([name, count]) => {
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${name}: ${count} c√¢y (${pct}%)</div>`;
        });
        treeTypesDetailEl.innerHTML = `<div style="font-weight:600;">T·ªïng lo·∫°i: ${totalDistinct}</div>` + rows.join('');
      }
      
      // C·∫≠p nh·∫≠t ph·∫ßn D·ªãch b·ªánh
      const diseasedEl = document.getElementById('diseasedTrees');
      const healthyEl = document.getElementById('healthyTrees');
      const unknownDiseaseEl = document.getElementById('unknownDisease');
      const commonDiseaseEl = document.getElementById('commonDisease');
      const diseaseDetailsEl = document.getElementById('diseaseDetails');
      if (diseasedEl) diseasedEl.textContent = `${diseased} c√¢y`;
      if (healthyEl) healthyEl.textContent = `${healthy} c√¢y`;
      if (unknownDiseaseEl) unknownDiseaseEl.textContent = `${unknownDisease} c√¢y`;
      if (commonDiseaseEl) {
        const diseaseSorted = Object.entries(diseaseStats).sort(([,a],[,b]) => b - a);
        commonDiseaseEl.textContent = diseaseSorted.length ? diseaseSorted[0][0] : '-';
      }
      if (diseaseDetailsEl) {
        const total = diseased; // ch·ªâ c·ªông t·ªïng c√¢y b·ªánh
        const diseaseSortedAZ = Object.entries(diseaseStats).sort((a,b) => a[0].localeCompare(b[0]));
        const rows = diseaseSortedAZ.map(([name, count]) => {
          const p = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${name}: ${count} c√¢y (${p}%)</div>`;
        }).join('');
        diseaseDetailsEl.innerHTML = rows; // b·ªè d√≤ng "T·ªïng: ... c√¢y" trong n·ªôi dung
        const diseaseHeaderTotal = document.getElementById('diseaseHeaderTotal');
        const diseaseTypesHeaderTotal = document.getElementById('diseaseTypesHeaderTotal');
        if (diseaseHeaderTotal) diseaseHeaderTotal.textContent = `${diseased} c√¢y`;
        if (diseaseTypesHeaderTotal) diseaseTypesHeaderTotal.textContent = `${diseased} c√¢y`;
      }

      // C·∫≠p nh·∫≠t ph·∫ßn NƒÉm tr·ªìng
      const yearDetailsEl = document.getElementById('yearDetails');
      if (yearDetailsEl) {
        const total = totalTrees || 0;
        const yearSorted = Object.entries(yearStats).sort((a,b) => parseInt(a[0]) - parseInt(b[0]));
        const rows = yearSorted.map(([y, c]) => {
          const p = total > 0 ? ((c / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${y}: ${c} c√¢y (${p}%)</div>`;
        }).join('');
        yearDetailsEl.innerHTML = rows; // b·ªè d√≤ng T·ªïng trong n·ªôi dung
        const yearHeaderTotal = document.getElementById('yearHeaderTotal');
        if (yearHeaderTotal) yearHeaderTotal.textContent = `${total} c√¢y`;
      }

      // C·∫≠p nh·∫≠t ph·∫ßn Qu·∫£n l√Ω t·ªïng
      const totalFarmsEl = document.getElementById('totalFarms');
      const totalTeamsEl = document.getElementById('totalTeams');
      const totalLotsEl = document.getElementById('totalLots');
      const totalWorkersEl = document.getElementById('totalWorkers');
      if (totalFarmsEl) totalFarmsEl.textContent = Object.keys(farmStats).length;
      if (totalTeamsEl) totalTeamsEl.textContent = Object.keys(teamStats).length;
      if (totalLotsEl) totalLotsEl.textContent = Object.keys(lotStats).length;
      if (totalWorkersEl) totalWorkersEl.textContent = Object.keys(workerStats).length;

      // T·ªïng s·ªë c√¢y cho t·ª´ng m·ª•c qu·∫£n l√Ω
      const totalFarmTreesElement = document.getElementById('totalFarmTrees');
      const totalTeamTreesElement = document.getElementById('totalTeamTrees');
      const totalLotTreesElement = document.getElementById('totalLotTrees');
      const totalWorkerTreesElement = document.getElementById('totalWorkerTrees');
      const sumValues = obj => Object.values(obj).reduce((s, c) => s + c, 0);
      if (totalFarmTreesElement) totalFarmTreesElement.textContent = `${sumValues(farmStats)} c√¢y`;
      if (totalTeamTreesElement) totalTeamTreesElement.textContent = `${sumValues(teamStats)} c√¢y`;
      if (totalLotTreesElement) totalLotTreesElement.textContent = `${sumValues(lotStats)} c√¢y`;
      if (totalWorkerTreesElement) totalWorkerTreesElement.textContent = `${sumValues(workerStats)} c√¢y`;

      // Chi ti·∫øt theo qu·∫£n l√Ω
      const farmDetailsEl = document.getElementById('farmDetails');
      const teamDetailsEl = document.getElementById('teamDetails');
      const lotDetailsEl = document.getElementById('lotDetails');
      const workerDetailsEl = document.getElementById('workerDetails');
      if (farmDetailsEl) {
        const total = totalTrees || 0;
        const sortedAZ = Object.entries(farmStats).sort((a,b) => a[0].localeCompare(b[0]));
        farmDetailsEl.innerHTML = sortedAZ.map(([name, count]) => {
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${name}: ${count} c√¢y (${pct}%)</div>`;
        }).join('');
      }
      if (teamDetailsEl) {
        const total = totalTrees || 0;
        const sortedAZ = Object.entries(teamStats).sort((a,b) => a[0].localeCompare(b[0]));
        teamDetailsEl.innerHTML = sortedAZ.map(([name, count]) => {
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${name}: ${count} c√¢y (${pct}%)</div>`;
        }).join('');
      }
      if (lotDetailsEl) {
        const total = totalTrees || 0;
        const sortedAZ = Object.entries(lotStats).sort((a,b) => a[0].localeCompare(b[0]));
        lotDetailsEl.innerHTML = sortedAZ.map(([name, count]) => {
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${name}: ${count} c√¢y (${pct}%)</div>`;
        }).join('');
      }
      if (workerDetailsEl) {
        const total = totalTrees || 0;
        const sortedAZ = Object.entries(workerStats).sort((a,b) => a[0].localeCompare(b[0]));
        workerDetailsEl.innerHTML = sortedAZ.map(([name, count]) => {
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          return `<div>‚Ä¢ ${name}: ${count} c√¢y (${pct}%)</div>`;
        }).join('');
      }

      console.log('ƒê√£ c·∫≠p nh·∫≠t th·ªëng k√™ th√†nh c√¥ng');
    }

    function updateLegend(colorStats) {
      // legend removed
    }

    // H√†m l·∫•y d·ªØ li·ªáu ƒë√£ l·ªçc ch√≠nh x√°c
    function getFilteredData() {
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const yearFilter = document.getElementById('yearFilter').value;
      const tenntFilter = document.getElementById('tenntFilter').value;
      const tendoiFilter = document.getElementById('tendoiFilter').value;
      const tendtFilter = document.getElementById('tendtFilter').value;
      const tenloFilter = document.getElementById('tenloFilter').value;
      const tenttFilter = document.getElementById('tenttFilter').value;
      const cnFilter = document.getElementById('cnFilter').value;
      const diseaseFilter = document.getElementById('diseaseFilter').value;

      const filteredData = [];
      markers.forEach(marker => {
        const data = marker.treeData;
        const matchesStatus = !statusFilter || data.chatLuong === statusFilter;
        const matchesType = !typeFilter || data.ten === typeFilter;
        const matchesYear = !yearFilter || (data.namTrong && parseInt(data.namTrong) === parseInt(yearFilter));
        const matchesTennt = !tenntFilter || data.tennt === tenntFilter;
        const matchesTendoi = !tendoiFilter || data.tendoi === tendoiFilter;
        const matchesTendt = !tendtFilter || data.tendt === tendtFilter;
        const matchesTenlo = !tenloFilter || data.tenlo === tenloFilter;
        const matchesTentt = !tenttFilter || data.tentt === tenttFilter;
        const matchesCn = !cnFilter || data.cn === cnFilter;
        const matchesDisease = !diseaseFilter || data.tinhtrangbenh === diseaseFilter;
        
        const isVisible = matchesStatus && matchesType && matchesYear && matchesTennt && matchesTendoi && matchesTendt && matchesTenlo && matchesTentt && matchesCn && matchesDisease;
        
        if (isVisible) {
          filteredData.push(data);
        }
      });
      
      return filteredData;
    }

    // H√†m debug ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu th·ªëng k√™
    function debugStats() {
      console.log('=== DEBUG STATS ===');
      console.log('T·ªïng s·ªë markers:', markers.length);
      console.log('T·ªïng s·ªë allTreeData:', allTreeData.length);
      console.log('S·ªë c√¢y ƒë√£ ch·ªânh s·ª≠a:', editedTreesList.size);
      console.log('Danh s√°ch c√¢y ƒë√£ ch·ªânh s·ª≠a:', Array.from(editedTreesList));
      
      // S·ª≠ d·ª•ng h√†m getFilteredData ƒë·ªÉ l·∫•y d·ªØ li·ªáu ch√≠nh x√°c
      const filteredData = getFilteredData();
      console.log('D·ªØ li·ªáu ƒë√£ l·ªçc:', filteredData.length, 'items');
      if (filteredData.length > 0) {
        console.log('Item ƒë·∫ßu ti√™n:', filteredData[0]);
      }
      
      // G·ªçi l·∫°i updateDataStatsPanel v·ªõi d·ªØ li·ªáu ƒë√£ l·ªçc
      updateDataStatsPanel(filteredData);
    }

    function toggleSummaryPanel() {
      const panel = document.getElementById('summaryPanel');
      const content = document.getElementById('summaryPanelContent');
      const btn = panel.querySelector('.minimize-btn');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '‚àí';
        btn.title = 'Thu g·ªçn';
      } else {
        content.style.display = 'none';
        btn.textContent = '+';
        btn.title = 'M·ªü r·ªông';
      }
    }
    function zoomToAll() {
      if (markers.length > 0) {
        if (clusteringEnabled && markerClusterGroup.getLayers().length > 0) {
          map.fitBounds(markerClusterGroup.getBounds().pad(0.1));
          console.log('Zoom to all markers (clustering):', markerClusterGroup.getBounds());
        } else if (markerGroup.getLayers().length > 0) {
        map.fitBounds(markerGroup.getBounds().pad(0.1));
          console.log('Zoom to all markers (no clustering):', markerGroup.getBounds());
        } else {
          console.warn('Kh√¥ng c√≥ markers ƒë·ªÉ zoom');
        }
      } else {
        console.warn('Kh√¥ng c√≥ markers ƒë·ªÉ zoom');
      }
    }



    function exportData() {
      if (allTreeData.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }
      
      const ws = XLSX.utils.json_to_sheet(allTreeData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'CayTrong');
      XLSX.writeFile(wb, 'cay_trong_export.xlsx');
    }

    function exportEditedData() {
      if (allTreeData.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }
      
      const ws = XLSX.utils.json_to_sheet(allTreeData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'CayTrong_Edited');
      XLSX.writeFile(wb, 'cay_trong_da_chinh_sua.xlsx');
      alert('ƒê√£ xu·∫•t d·ªØ li·ªáu ƒë√£ ch·ªânh s·ª≠a th√†nh c√¥ng!');
    }

    // ===== C·∫§U TR√öC POPUP M·ªöI =====
    
    // H√†m t·∫°o popup xem th√¥ng tin (ch·∫ø ƒë·ªô xem)
    function createViewPopup(id, data) {
      return `
        <div class="tree-popup" id="popup-${id}">
          <div class="popup-header ${data.saved ? 'success' : ''} expanded" data-action="toggle" data-id="${id}">
            <h4>üÜî ID: ${id} ${data.saved ? '<span class="saved-indicator">‚úì ƒê√£ l∆∞u</span>' : ''}</h4>
          </div>
          
          <div class="popup-content">
            <div class="info-grid">
              <div class="info-group">
                <label>T√™n c√¢y:</label>
                <div class="info-value">${data.ten || 'N/A'}</div>
              </div>
              
              <div class="info-group">
                <label>NƒÉm tr·ªìng:</label>
                <div class="info-value">${data.namTrong || 'N/A'}</div>
              </div>
              
              <div class="info-group">
                <label>Ng√†y tr·ªìng:</label>
                <div class="info-value">${data.ngayTrong ? formatDateFromExcel(data.ngayTrong) : 'N/A'}</div>
              </div>
              
              <div class="info-group">
                <label>Ch·∫•t l∆∞·ª£ng:</label>
                <div class="info-value quality-${(data.chatLuong || '').toLowerCase().replace(' ', '-') || 'unknown'}">${data.chatLuong || 'Ch∆∞a x√°c ƒë·ªãnh'}</div>
              </div>
            </div>
            
            <div class="info-group">
              <label>T√¨nh tr·∫°ng b·ªánh:</label>
              <div class="info-value">${data.tinhtrangbenh || 'Kh√¥ng c√≥'}</div>
            </div>
            
            <div class="management-section">
              <h5>üìã Th√¥ng tin qu·∫£n l√Ω:</h5>
              <div class="management-grid">
                <div class="info-group">
                  <label>N√¥ng tr∆∞·ªùng:</label>
                  <div class="info-value">${data.tennt || 'N/A'}</div>
                </div>
                <div class="info-group">
                  <label>Gi√°m ƒë·ªëc:</label>
                  <div class="info-value">${data.tengd || 'N/A'}</div>
                </div>
                <div class="info-group">
                  <label>ƒê·ªôi:</label>
                  <div class="info-value">${data.tendoi || 'N/A'}</div>
                </div>
                <div class="info-group">
                  <label>ƒê·ªôi tr∆∞·ªüng:</label>
                  <div class="info-value">${data.tendt || 'N/A'}</div>
                </div>
                <div class="info-group">
                  <label>L√¥:</label>
                  <div class="info-value">${data.tenlo || 'N/A'}</div>
                </div>
                <div class="info-group">
                  <label>T·ªï tr∆∞·ªüng:</label>
                  <div class="info-value">${data.tentt || 'N/A'}</div>
                </div>
                <div class="info-group full-width">
                  <label>C√¥ng nh√¢n:</label>
                  <div class="info-value">${data.cn || 'N/A'}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="popup-actions">
            <button class="btn-edit" data-action="edit" data-id="${id}">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
            <button class="btn-cancel" data-action="close" data-id="${id}">‚ùå ƒê√≥ng</button>
          </div>
        </div>
      `;
    }
    
    // H√†m t·∫°o popup ch·ªânh s·ª≠a
    function createEditPopup(id, data) {
      return `
        <div class="tree-popup" id="popup-${id}">
          <div class="popup-header edit-mode expanded" data-action="toggle" data-id="${id}">
            <h4>üÜî ID: ${id} - Ch·ªânh s·ª≠a</h4>
          </div>
          
          <div class="popup-content">
            <div class="form-grid">
              <div class="form-group">
                <label>T√™n c√¢y:</label>
                <input type="text" id="edit-ten-${id}" value="${data.ten || ''}" />
              </div>
              
              <div class="form-group">
                <label>NƒÉm tr·ªìng:</label>
                <input type="number" id="edit-nam-${id}" value="${data.namTrong || ''}" />
              </div>
              
              <div class="form-group">
                <label>Ng√†y tr·ªìng:</label>
                <input type="date" id="edit-ngay-${id}" value="${formatDateForInput(data.ngayTrong)}" />
              </div>
              
              <div class="form-group">
                <label>Ch·∫•t l∆∞·ª£ng:</label>
                <select id="edit-chatluong-${id}">
                  <option value="T·ªët" ${data.chatLuong === 'T·ªët' ? 'selected' : ''}>T·ªët</option>
                  <option value="Trung b√¨nh" ${data.chatLuong === 'Trung b√¨nh' ? 'selected' : ''}>Trung b√¨nh</option>
                  <option value="K√©m" ${data.chatLuong === 'K√©m' ? 'selected' : ''}>K√©m</option>
                  <option value="Ch∆∞a x√°c ƒë·ªãnh" ${!data.chatLuong || data.chatLuong === 'Ch∆∞a x√°c ƒë·ªãnh' ? 'selected' : ''}>Ch∆∞a x√°c ƒë·ªãnh</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label>T√¨nh tr·∫°ng b·ªánh:</label>
              <input type="text" id="edit-benh-${id}" value="${data.tinhtrangbenh || ''}" placeholder="Nh·∫≠p t√¨nh tr·∫°ng b·ªánh..." />
            </div>
            
            <div class="management-section">
              <h5>üìã Th√¥ng tin qu·∫£n l√Ω:</h5>
              <div class="management-grid">
                <div class="form-group">
                  <label>N√¥ng tr∆∞·ªùng:</label>
                  <input type="text" id="edit-tennt-${id}" value="${data.tennt || ''}" />
                </div>
                <div class="form-group">
                  <label>Gi√°m ƒë·ªëc:</label>
                  <input type="text" id="edit-tengd-${id}" value="${data.tengd || ''}" />
                </div>
                <div class="form-group">
                  <label>ƒê·ªôi:</label>
                  <input type="text" id="edit-tendoi-${id}" value="${data.tendoi || ''}" />
                </div>
                <div class="form-group">
                  <label>ƒê·ªôi tr∆∞·ªüng:</label>
                  <input type="text" id="edit-tendt-${id}" value="${data.tendt || ''}" />
                </div>
                <div class="form-group">
                  <label>L√¥:</label>
                  <input type="text" id="edit-tenlo-${id}" value="${data.tenlo || ''}" />
                </div>
                <div class="form-group">
                  <label>T·ªï tr∆∞·ªüng:</label>
                  <input type="text" id="edit-tentt-${id}" value="${data.tentt || ''}" />
                </div>
                <div class="form-group full-width">
                  <label>C√¥ng nh√¢n:</label>
                  <input type="text" id="edit-cn-${id}" value="${data.cn || ''}" />
                </div>
              </div>
            </div>
          </div>
          
          <div class="popup-actions">
            <button class="btn-save" data-action="save" data-id="${id}">üíæ L∆∞u</button>
            <button class="btn-cancel" data-action="cancel" data-id="${id}">‚ùå H·ªßy</button>
          </div>
        </div>
      `;
    }
    
    // H√†m chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
    function switchToEditMode(id) {
      console.log('Chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a cho ID:', id);
      
      const marker = markers.find(m => m.treeData && m.treeData.id === id);
      if (!marker) {
        console.error('Kh√¥ng t√¨m th·∫•y marker v·ªõi ID:', id);
        return;
      }
      
      console.log('T√¨m th·∫•y marker:', marker);
      
      // T·∫°o popup m·ªõi
      const editPopupContent = createEditPopup(id, marker.treeData);
      console.log('N·ªôi dung popup ch·ªânh s·ª≠a:', editPopupContent);
      
      // Bind popup m·ªõi
      marker.bindPopup(editPopupContent);
      
      // M·ªü popup
      marker.openPopup();
      
      // Focus v√†o tr∆∞·ªùng ƒë·∫ßu ti√™n sau khi popup m·ªü
      setTimeout(() => {
        const firstInput = document.getElementById(`edit-ten-${id}`);
        if (firstInput) {
          firstInput.focus();
          console.log('ƒê√£ focus v√†o tr∆∞·ªùng ƒë·∫ßu ti√™n');
          
          // Th√™m event listener cho ph√≠m Enter
          const inputs = document.querySelectorAll(`#popup-${id} input, #popup-${id} select`);
          inputs.forEach(input => {
            input.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                saveTreeEdit(id);
              }
            });
          });
        } else {
          console.warn('Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng input ƒë·∫ßu ti√™n');
        }
      }, 200);
    }
    
    // H√†m chuy·ªÉn sang ch·∫ø ƒë·ªô xem
    function switchToViewMode(id) {
      console.log('Chuy·ªÉn sang ch·∫ø ƒë·ªô xem cho ID:', id);
      
      const marker = markers.find(m => m.treeData && m.treeData.id === id);
      if (!marker) {
        console.error('Kh√¥ng t√¨m th·∫•y marker v·ªõi ID:', id);
        return;
      }
      
      // T·∫°o popup m·ªõi
      const viewPopupContent = createViewPopup(id, marker.treeData);
      
      // Bind popup m·ªõi
      marker.bindPopup(viewPopupContent);
      
      // M·ªü popup
      marker.openPopup();
    }
    
    // H√†m ƒë√≥ng popup
    function closePopup(id) {
      const marker = markers.find(m => m.treeData && m.treeData.id === id);
      if (marker) {
        marker.closePopup();
      }
    }
    
    // H√†m toggle popup content (thu g·ªçn/m·ªü r·ªông)
    function togglePopupContent(id) {
      const popup = document.getElementById(`popup-${id}`);
      if (!popup) return;
      
      const header = popup.querySelector('.popup-header');
      const content = popup.querySelector('.popup-content');
      const actions = popup.querySelector('.popup-actions');
      
      if (header && content && actions) {
        const isCollapsed = header.classList.contains('collapsed');
        
        if (isCollapsed) {
          // M·ªü r·ªông
          header.classList.remove('collapsed');
          header.classList.add('expanded');
          content.classList.remove('collapsed');
          actions.classList.remove('collapsed');
        } else {
          // Thu g·ªçn
          header.classList.remove('expanded');
          header.classList.add('collapsed');
          content.classList.add('collapsed');
          actions.classList.add('collapsed');
        }
      }
    }
    
    // H√†m l∆∞u ch·ªânh s·ª≠a c√¢y - Phi√™n b·∫£n m·ªõi ƒë∆°n gi·∫£n
    function saveTreeEdit(id) {
      try {
        console.log('B·∫Øt ƒë·∫ßu l∆∞u c√¢y v·ªõi ID:', id);
        
        // Ki·ªÉm tra ID h·ª£p l·ªá
        if (!id || id.trim() === '') {
          throw new Error('ID c√¢y kh√¥ng h·ª£p l·ªá!');
        }
        
        // L·∫•y d·ªØ li·ªáu t·ª´ form
        const formData = {
          ten: document.getElementById(`edit-ten-${id}`)?.value || '',
          namTrong: document.getElementById(`edit-nam-${id}`)?.value || '',
          ngayTrong: document.getElementById(`edit-ngay-${id}`)?.value || '',
          chatLuong: document.getElementById(`edit-chatluong-${id}`)?.value || '',
          tinhtrangbenh: document.getElementById(`edit-benh-${id}`)?.value || '',
          tennt: document.getElementById(`edit-tennt-${id}`)?.value || '',
          tengd: document.getElementById(`edit-tengd-${id}`)?.value || '',
          tendoi: document.getElementById(`edit-tendoi-${id}`)?.value || '',
          tendt: document.getElementById(`edit-tendt-${id}`)?.value || '',
          tenlo: document.getElementById(`edit-tenlo-${id}`)?.value || '',
          tentt: document.getElementById(`edit-tentt-${id}`)?.value || '',
          cn: document.getElementById(`edit-cn-${id}`)?.value || ''
        };
        
        console.log('D·ªØ li·ªáu form:', formData);
        
        // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
        if (!formData.ten.trim()) {
          throw new Error('T√™n c√¢y kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
        }
        
        // T√¨m marker
        const marker = markers.find(m => m.treeData && m.treeData.id === id);
        if (!marker) {
          throw new Error('Kh√¥ng t√¨m th·∫•y c√¢y ƒë·ªÉ c·∫≠p nh·∫≠t!');
        }
        
        // C·∫≠p nh·∫≠t marker data
        Object.assign(marker.treeData, formData);
        
        // C·∫≠p nh·∫≠t allTreeData
        const dataIndex = allTreeData.findIndex(row => {
          const rowId = (row.id || row.ID || row.Id || '').toString().trim();
          return rowId === id;
        });
        if (dataIndex !== -1) {
          allTreeData[dataIndex] = { ...allTreeData[dataIndex], ...formData };
          console.log('ƒê√£ c·∫≠p nh·∫≠t allTreeData t·∫°i index:', dataIndex);
        } else {
          console.warn('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu trong allTreeData cho ID:', id);
        }
        
        // C·∫≠p nh·∫≠t m√†u marker
        const colors = {
          'T·ªët': '#27ae60',
          'Trung b√¨nh': '#f39c12', 
          'K√©m': '#e74c3c'
        };
        const markerColor = colors[formData.chatLuong] || '#95a5a6';
        marker.setStyle({ color: markerColor, fillColor: markerColor });
        
        // Chuy·ªÉn sang popup xem th√¥ng tin v·ªõi th√¥ng b√°o ƒë√£ l∆∞u
        const updatedData = { ...marker.treeData, saved: true };
        marker.bindPopup(createViewPopup(id, updatedData));
        marker.openPopup(); // M·ªü popup m·ªõi ngay l·∫≠p t·ª©c
        
        // C·∫≠p nh·∫≠t filters
        updateFilterOptions();
        updateStats(markers.length, {}, {}, {});
        
        console.log('L∆∞u th√†nh c√¥ng!');
        // Thay v√¨ alert, hi·ªÉn th·ªã th√¥ng b√°o trong popup
        
      } catch (error) {
        console.error('L·ªói khi l∆∞u:', error);
        alert('L·ªói: ' + error.message);
      }
    }
    
    // H√†m xu·∫•t d·ªØ li·ªáu ƒë√£ ch·ªânh s·ª≠a ra file Excel
    function exportUpdatedData() {
      if (allTreeData.length === 0) {
        console.warn('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
        return;
      }
      
      try {
        // T·∫°o workbook m·ªõi
        const wb = XLSX.utils.book_new();
        
        // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ xu·∫•t
        const exportData = allTreeData.map(row => {
          // T√¨m marker t∆∞∆°ng ·ª©ng ƒë·ªÉ l·∫•y t·ªça ƒë·ªô m·ªõi nh·∫•t
          const marker = markers.find(m => m.treeData && m.treeData.id === (row.id || row.ID || row.Id || '').toString().trim());
          
          return {
            'ID': row.id || row.ID || row.Id || '',
            'T√™n c√¢y': row.ten || '',
            'NƒÉm tr·ªìng': row.nam_trong || '',
            'Ng√†y tr·ªìng': row.ngaytrong || '',
            'Ch·∫•t l∆∞·ª£ng': row.chat_luong || '',
            'T√¨nh tr·∫°ng b·ªánh': row.tinhtrangbenh || '',
            'M√†u c√¢y': row.mauCay || '',
            'M√†u': row.mau || '',
            'T√™n n√¥ng tr∆∞·ªùng': row.tennt || '',
            'T√™n gi√°m ƒë·ªëc n√¥ng tr∆∞·ªùng': row.tengd || '',
            'T√™n ƒë·ªôi': row.tendoi || '',
            'T√™n ƒë·ªôi tr∆∞·ªüng': row.tendt || '',
            'T√™n l√¥': row.tenlo || '',
            'T√™n t·ªï tr∆∞·ªüng': row.tentt || '',
            'T√™n c√¥ng nh√¢n': row.cn || '',
            'T·ªça ƒë·ªô X': marker ? marker.treeData.lat : (row.lat || ''),
            'T·ªça ƒë·ªô Y': marker ? marker.treeData.lon : (row.lon || ''),
            'Th·ªùi gian ch·ªânh s·ª≠a': new Date().toLocaleString('vi-VN')
          };
        });
        
        // T·∫°o worksheet
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // ƒê·∫∑t ƒë·ªô r·ªông c·ªôt
        const colWidths = [
          { wch: 8 },   // ID
          { wch: 15 },  // T√™n c√¢y
          { wch: 10 },  // NƒÉm tr·ªìng
          { wch: 12 },  // Ng√†y tr·ªìng
          { wch: 12 },  // Ch·∫•t l∆∞·ª£ng
          { wch: 15 },  // T√¨nh tr·∫°ng b·ªánh
          { wch: 10 },  // M√†u c√¢y
          { wch: 10 },  // M√†u
          { wch: 15 },  // T√™n n√¥ng tr∆∞·ªùng
          { wch: 20 },  // T√™n gi√°m ƒë·ªëc
          { wch: 12 },  // T√™n ƒë·ªôi
          { wch: 15 },  // T√™n ƒë·ªôi tr∆∞·ªüng
          { wch: 10 },  // T√™n l√¥
          { wch: 15 },  // T√™n t·ªï tr∆∞·ªüng
          { wch: 15 },  // T√™n c√¥ng nh√¢n
          { wch: 12 },  // T·ªça ƒë·ªô X
          { wch: 12 },  // T·ªça ƒë·ªô Y
          { wch: 20 }   // Th·ªùi gian ch·ªânh s·ª≠a
        ];
        ws['!cols'] = colWidths;
        
        // Th√™m worksheet v√†o workbook
        XLSX.utils.book_append_sheet(wb, ws, 'CayTrong_DaChinhSua');
        
        // T·∫°o t√™n file v·ªõi timestamp
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
        const fileName = `CayTrong_DaChinhSua_${timestamp}.xlsx`;
        
        // Xu·∫•t file
        XLSX.writeFile(wb, fileName);
        
        console.log(`ƒê√£ xu·∫•t file Excel: ${fileName}`);
        
      } catch (error) {
        console.error('L·ªói khi xu·∫•t file Excel:', error);
        alert('C√≥ l·ªói khi xu·∫•t file Excel: ' + error.message);
      }
    }

    // H√†m chuy·ªÉn t·ª´ ch·∫ø ƒë·ªô xem sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a

    // H√†m h·ªßy ch·ªânh s·ª≠a c√¢y - Chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô xem
    function cancelTreeEdit(id) {
      switchToViewMode(id);
    }

    function editTree(id, ten, namTrong, ngayTrong, chatLuong, tinhtrangbenh, mauCay, mau, tennt, tengd, tendoi, tendt, tenlo, tentt, cn) {
      document.getElementById('editId').value = id;
      document.getElementById('editTen').value = ten;
      document.getElementById('editNam').value = namTrong;
      document.getElementById('editNgayTrong').value = formatDateFromExcel(ngayTrong);
      document.getElementById('editChatLuong').value = chatLuong;
      document.getElementById('editTinhtrangbenh').value = tinhtrangbenh;
      document.getElementById('editMauCay').value = mauCay;
      document.getElementById('editMau').value = mau;
      document.getElementById('editTennt').value = tennt;
      document.getElementById('editTengd').value = tengd;
      document.getElementById('editTendoi').value = tendoi;
      document.getElementById('editTendt').value = tendt;
      document.getElementById('editTenlo').value = tenlo;
      document.getElementById('editTentt').value = tentt;
      document.getElementById('editCn').value = cn;
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function saveTreeEditModal() {
      const id = document.getElementById('editId').value;
      const ten = document.getElementById('editTen').value;
      const mauCay = document.getElementById('editMauCay').value;
      const namTrong = document.getElementById('editNam').value;
      const ngayTrong = document.getElementById('editNgayTrong').value;
      const chatLuong = document.getElementById('editChatLuong').value;
      const mau = document.getElementById('editMau').value;
      const tinhtrangbenh = document.getElementById('editTinhtrangbenh').value;
      const tennt = document.getElementById('editTennt').value;
      const tengd = document.getElementById('editTengd').value;
      const tendoi = document.getElementById('editTendoi').value;
      const tendt = document.getElementById('editTendt').value;
      const tenlo = document.getElementById('editTenlo').value;
      const tentt = document.getElementById('editTentt').value;
      const cn = document.getElementById('editCn').value;

      // C·∫≠p nh·∫≠t marker
      const marker = markers.find(m => m.treeData.id === id);
      if (marker) {
        marker.treeData.ten = ten;
        marker.treeData.mauCay = mauCay;
        marker.treeData.namTrong = namTrong;
        marker.treeData.ngayTrong = ngayTrong;
        marker.treeData.chatLuong = chatLuong;
        marker.treeData.mau = mau;
        marker.treeData.tinhtrangbenh = tinhtrangbenh;
        marker.treeData.tennt = tennt;
        marker.treeData.tengd = tengd;
        marker.treeData.tendoi = tendoi;
        marker.treeData.tendt = tendt;
        marker.treeData.tenlo = tenlo;
        marker.treeData.tentt = tentt;
        marker.treeData.cn = cn;

        // C·∫≠p nh·∫≠t m√†u s·∫Øc
        let newMau = 'green';
        if (mauCay) {
          newMau = mauCay.toLowerCase();
        } else if (mau) {
          newMau = mau.toLowerCase();
        } else if (chatLuong.toLowerCase().includes('t·ªët')) {
          newMau = 'green';
        } else if (chatLuong.toLowerCase().includes('trung b√¨nh')) {
          newMau = 'orange';
        } else if (chatLuong.toLowerCase().includes('x·∫•u')) {
          newMau = 'red';
        }

        marker.treeData.markerColor = newMau;
        marker.setStyle({ color: newMau, fillColor: newMau });

        // C·∫≠p nh·∫≠t popup v·ªõi th√¥ng tin m·ªõi
        const data = marker.treeData;
        marker.bindPopup(`
          <div style="min-width: 220px;">
            <h4 style="margin: 0 0 8px 0; color: #2c3e50; background: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 4px solid #3498db;">
              üÜî ID: ${data.id}
            </h4>
            <p style="margin: 2px 0;"><strong>T√™n c√¢y:</strong> <span style="color: ${data.mauCay || 'black'}; font-weight: bold;">${data.ten}</span></p>
            <p style="margin: 2px 0;"><strong>NƒÉm tr·ªìng:</strong> ${data.namTrong}</p>
            ${data.ngayTrong ? `<p style="margin: 2px 0;"><strong>Ng√†y tr·ªìng:</strong> ${formatDateFromExcel(data.ngayTrong)}</p>` : ''}
            <p style="margin: 2px 0;"><strong>Ch·∫•t l∆∞·ª£ng:</strong> <span style="color: ${data.mau || 'black'}; font-weight: bold;">${data.chatLuong || 'Ch∆∞a x√°c ƒë·ªãnh'}</span></p>
            ${data.tinhtrangbenh ? `<p style="margin: 2px 0;"><strong>T√¨nh tr·∫°ng b·ªánh:</strong> <span style="color: #e74c3c;">${data.tinhtrangbenh}</span></p>` : ''}
            
            <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #27ae60;">
              <h5 style="margin: 0 0 6px 0; color: #27ae60; font-size: 12px;">üìã Th√¥ng tin qu·∫£n l√Ω:</h5>
              ${data.tennt ? `<p style="margin: 2px 0; font-size: 11px;"><strong>T√™n n√¥ng tr∆∞·ªùng:</strong> ${data.tennt}</p>` : ''}
              ${data.tengd ? `<p style="margin: 2px 0; font-size: 11px;"><strong>Gi√°m ƒë·ªëc:</strong> ${data.tengd}</p>` : ''}
              ${data.tendoi ? `<p style="margin: 2px 0; font-size: 11px;"><strong>T√™n ƒë·ªôi:</strong> ${data.tendoi}</p>` : ''}
              ${data.tenlo ? `<p style="margin: 2px 0; font-size: 11px;"><strong>T√™n l√¥:</strong> ${data.tenlo}</p>` : ''}
              ${data.tentt ? `<p style="margin: 2px 0; font-size: 11px;"><strong>T√™n t·ªï tr∆∞·ªüng:</strong> ${data.tentt}</p>` : ''}
              ${data.cn ? `<p style="margin: 2px 0; font-size: 11px;"><strong>C√¥ng nh√¢n:</strong> ${data.cn}</p>` : ''}
            </div>
            
            <div style="margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap;">
              <button onclick="editTree('${data.id}', '${data.ten}', '${data.namTrong}', '${data.ngayTrong}', '${data.chatLuong}', '${data.tinhtrangbenh}', '${data.mauCay}', '${data.mau}', '${data.tennt}', '${data.tengd}', '${data.tendoi}', '${data.tendt}', '${data.tenlo}', '${data.tentt}', '${data.cn}')" style="padding: 4px 8px; background: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                ‚úèÔ∏è S·ª≠a
              </button>
            </div>
          </div>
        `);
      }
      
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu g·ªëc
      const dataIndex = allTreeData.findIndex(row => (row.id || row.ID) === id);
      if (dataIndex !== -1) {
        allTreeData[dataIndex].ten = ten;
        allTreeData[dataIndex].mau_cay = mauCay;
        allTreeData[dataIndex].nam_trong = namTrong;
        allTreeData[dataIndex].ngaytrong = ngayTrong;
        allTreeData[dataIndex].chat_luong = chatLuong;
        allTreeData[dataIndex].mau = mau;
        allTreeData[dataIndex].tinhtrangbenh = tinhtrangbenh;
        allTreeData[dataIndex].tennt = tennt;
        allTreeData[dataIndex].tengd = tengd;
        allTreeData[dataIndex].tendoi = tendoi;
        allTreeData[dataIndex].tendt = tendt;
        allTreeData[dataIndex].tenlo = tenlo;
        allTreeData[dataIndex].tentt = tentt;
        allTreeData[dataIndex].cn = cn;
      }

      // Th√™m ID v√†o danh s√°ch c√¢y ƒë√£ ch·ªânh s·ª≠a
      editedTreesList.add(id);

      // C·∫≠p nh·∫≠t l·∫°i b·ªô l·ªçc v√† th·ªëng k√™
      updateFilterOptions();
      
      // T√≠nh to√°n l·∫°i th·ªëng k√™ t·ª´ markers
      let tong = 0;
      let chatLuongStats = {};
      let loaiCayStats = {};
      let colorStats = {};
      
      markers.forEach(marker => {
        const data = marker.treeData;
        chatLuongStats[data.chatLuong] = (chatLuongStats[data.chatLuong] || 0) + 1;
        loaiCayStats[data.ten] = (loaiCayStats[data.ten] || 0) + 1;
        colorStats[data.markerColor] = (colorStats[data.markerColor] || 0) + 1;
        tong++;
      });
      
      updateStats(tong, chatLuongStats, loaiCayStats, colorStats);
      updateManagementStats(allTreeData);
      
      // C·∫≠p nh·∫≠t th·ªëng k√™ t·ª´ d·ªØ li·ªáu ƒë√£ l·ªçc sau khi ch·ªânh s·ª≠a
      const filteredData = getFilteredData();
      console.log('C·∫≠p nh·∫≠t th·ªëng k√™ sau khi ch·ªânh s·ª≠a:', filteredData.length, 'items');
      updateDataStatsPanel(filteredData);

      closeEditModal();
      
      // Th√¥ng b√°o th√†nh c√¥ng
      alert('ƒê√£ l∆∞u th√¥ng tin c√¢y th√†nh c√¥ng!');
    }

    // Ch·ª©c nƒÉng thu g·ªçn/m·ªü r·ªông
    function toggleControlGroup(element) {
      element.classList.toggle('collapsed');
      const content = element.nextElementSibling;
      content.classList.toggle('collapsed');
    }

    function toggleControlPanel() {
      const panel = document.querySelector('.control-panel');
      const content = panel.querySelector('.control-panel-content');
      const btn = panel.querySelector('.minimize-btn');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '‚àí';
        btn.title = 'Thu g·ªçn';
      } else {
        content.style.display = 'none';
        btn.textContent = '+';
        btn.title = 'M·ªü r·ªông';
      }
    }


    function toggleChartContainer() {
      const container = document.getElementById('chartContainer');
      const canvases = container.querySelectorAll('canvas');
      const btn = container.querySelector('.minimize-btn');
      
      if (canvases[0].style.display === 'none') {
        canvases.forEach(canvas => canvas.style.display = 'block');
        btn.textContent = '‚àí';
        btn.title = 'Thu g·ªçn';
      } else {
        canvases.forEach(canvas => canvas.style.display = 'none');
        btn.textContent = '+';
        btn.title = 'M·ªü r·ªông';
      }
    }


    function toggleLegend() { /* legend removed */ }

    // Ch·ª©c nƒÉng v·∫Ω ƒëa gi√°c
    function startPolygonDrawing() {
      // X√≥a mode c≈©
      if (currentDrawingMode) {
        document.getElementById('polygonBtn').classList.remove('active');
        if (polygonHandler) {
          polygonHandler.disable();
        }
      }
      
      // Ki·ªÉm tra n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô v·∫Ω ƒëa gi√°c
      if (currentDrawingMode === 'polygon') {
        currentDrawingMode = null;
        document.getElementById('polygonBtn').classList.remove('active');
        if (polygonHandler) {
          polygonHandler.disable();
        }
        return;
      }
      
      currentDrawingMode = 'polygon';
      document.getElementById('polygonBtn').classList.add('active');
      
      // T·∫°o polygon handler
      polygonHandler = new L.Draw.Polygon(map, {
        allowIntersection: false,
        showArea: true,
        drawError: {
          color: '#e1e100',
          message: '<strong>L·ªói:</strong> H√¨nh d·∫°ng kh√¥ng h·ª£p l·ªá!'
        },
        shapeOptions: {
          color: '#bada55',
          weight: 2,
          fillOpacity: 0.3
        }
      });
      
      // K√≠ch ho·∫°t handler
      polygonHandler.enable();
      
      
      // L·∫Øng nghe s·ª± ki·ªán v·∫Ω xong
      map.on(L.Draw.Event.CREATED, function(event) {
        const layer = event.layer;
        drawnItems.addLayer(layer);
        if (layer instanceof L.Polygon) {
          // T√≠nh di·ªán t√≠ch ch√≠nh x√°c theo WGS84
          const latLngs = layer.getLatLngs()[0];
          let area = 0;
          
          // S·ª≠ d·ª•ng c√¥ng th·ª©c t√≠nh di·ªán t√≠ch tr√™n m·∫∑t c·∫ßu
          for (let i = 0; i < latLngs.length; i++) {
            const j = (i + 1) % latLngs.length;
            const lat1 = latLngs[i].lat * Math.PI / 180;
            const lng1 = latLngs[i].lng * Math.PI / 180;
            const lat2 = latLngs[j].lat * Math.PI / 180;
            const lng2 = latLngs[j].lng * Math.PI / 180;
            
            area += (lng2 - lng1) * (2 + Math.sin(lat1) + Math.sin(lat2));
          }
          
          // B√°n k√≠nh Tr√°i ƒê·∫•t (m√©t)
          const R = 6371000;
          area = Math.abs(area * R * R / 2);
          
          const areaM2 = area.toFixed(2);
          const areaHa = (area / 10000).toFixed(2);
          layer.areaM2 = areaM2;
          layer.areaHa = areaHa;
          layer.bindPopup(`Di·ªán t√≠ch: ${areaM2} m¬≤ (${areaHa} ha)`);
        }
        
        // T·∫Øt ch·∫ø ƒë·ªô v·∫Ω sau khi v·∫Ω xong
        currentDrawingMode = null;
        document.getElementById('polygonBtn').classList.remove('active');
        if (polygonHandler) {
          polygonHandler.disable();
        }
        
      });

      // B·ªè c·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p
    }

    function clearDrawings() {
      if (drawnItems.getLayers().length === 0 && distanceLayer.getLayers().length === 0) {
        return;
      }
      
      drawnItems.clearLayers();
      clearDistanceMeasure();
      
      // T·∫Øt c√°c ch·∫ø ƒë·ªô v·∫Ω
      if (currentDrawingMode) {
        currentDrawingMode = null;
        document.getElementById('polygonBtn').classList.remove('active');
        if (polygonHandler) {
          polygonHandler.disable();
        }
      }
      
      if (distanceMode) {
        distanceMode = false;
        document.getElementById('distanceBtn').classList.remove('active');
      }
    }

    
    
    // H√†m b·∫Øt ƒë·∫ßu ƒëo kho·∫£ng c√°ch
    function startDistanceMeasure() {
      // T·∫Øt mode c≈©
      if (currentDrawingMode) {
        document.getElementById('polygonBtn').classList.remove('active');
        if (polygonHandler) {
          polygonHandler.disable();
        }
      }
      
      // Ki·ªÉm tra n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ƒëo kho·∫£ng c√°ch
      if (distanceMode) {
        distanceMode = false;
        document.getElementById('distanceBtn').classList.remove('active');
        clearDistanceMeasure();
        return;
      }
      
      distanceMode = true;
      document.getElementById('distanceBtn').classList.add('active');
      clearDistanceMeasure();
      // Con tr·ªè ch·ªØ th·∫≠p khi ·ªü ch·∫ø ƒë·ªô ƒëo kho·∫£ng c√°ch
      try { map.getContainer().style.cursor = 'crosshair'; } catch(_) {}
      
      // C·∫≠p nh·∫≠t status bar
      document.getElementById('statusBar').textContent = 
        `Ch·∫ø ƒë·ªô ƒëo kho·∫£ng c√°ch | Click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ th√™m ƒëi·ªÉm | Double-click ƒë·ªÉ k·∫øt th√∫c`;
    }
    
    // H√†m th√™m ƒëi·ªÉm ƒëo kho·∫£ng c√°ch
    function addDistancePoint(latlng) {
      distancePoints.push(latlng);
      
      // N·∫øu c√≥ √≠t nh·∫•t 2 ƒëi·ªÉm, v·∫Ω ƒë∆∞·ªùng n·ªëi li√™n t·ª•c
      if (distancePoints.length >= 2) {
        // X√≥a ƒë∆∞·ªùng c≈© n·∫øu c√≥
        if (distanceLines.length > 0) {
          distanceLayer.removeLayer(distanceLines[0]);
        }
        
        // V·∫Ω ƒë∆∞·ªùng m·ªõi v·ªõi t·∫•t c·∫£ c√°c ƒëi·ªÉm
        const line = L.polyline(distancePoints, {
          color: '#ff0000',
          weight: 4,
          opacity: 0.9,
          dashArray: '8, 8'
        }).addTo(distanceLayer);
        
        distanceLines = [line]; // Ch·ªâ gi·ªØ 1 ƒë∆∞·ªùng duy nh·∫•t
        
        // C·∫≠p nh·∫≠t t·ªïng kho·∫£ng c√°ch
        updateTotalDistance();
      }
      
      // T·∫°o marker draggable cho ƒëi·ªÉm v·ª´a th√™m (c√≥ th·ªÉ k√©o s·ª≠a ƒëi·ªÉm)
      const pointMarker = L.circleMarker(latlng, { radius: 5, color: '#ff0000', fillColor: '#ff0000', fillOpacity: 0.9, weight: 2, draggable: true });
      // Bi·∫øn circleMarker kh√¥ng h·ªó tr·ª£ draggable native -> d√πng marker v·ªõi icon nh·ªè
      const handle = L.marker(latlng, { draggable: true, icon: L.divIcon({className:'distance-handle', html:'', iconSize:[8,8]}) }).addTo(distanceLayer);
      handle.on('drag', function(e){
        const idx = distancePoints.length - 1;
        distancePoints[idx] = e.target.getLatLng();
        // V·∫Ω l·∫°i ƒë∆∞·ªùng
        if (distanceLines.length > 0) distanceLayer.removeLayer(distanceLines[0]);
        if (distancePoints.length >= 2) {
          const line = L.polyline(distancePoints, { color: '#ff0000', weight: 4, opacity: 0.9, dashArray: '8, 8' }).addTo(distanceLayer);
          distanceLines = [line];
        }
        updateTotalDistance();
      });

      // C·∫≠p nh·∫≠t status bar
      const totalDistance = calculateTotalDistance();
      const totalKm = (totalDistance / 1000).toFixed(2);
      const totalM = totalDistance.toFixed(2);
      
      document.getElementById('statusBar').textContent = 
        `ƒêi·ªÉm ${distancePoints.length} | T·ªïng: ${totalM}m (${totalKm}km) | Double-click ƒë·ªÉ k·∫øt th√∫c`;
    }
    
    // H√†m t√≠nh t·ªïng kho·∫£ng c√°ch
    function calculateTotalDistance() {
      if (distancePoints.length < 2) return 0;
      
      let totalDistance = 0;
      for (let i = 1; i < distancePoints.length; i++) {
        totalDistance += distancePoints[i].distanceTo(distancePoints[i - 1]);
      }
      return totalDistance;
    }
    
    // H√†m c·∫≠p nh·∫≠t t·ªïng kho·∫£ng c√°ch
    function updateTotalDistance() {
      if (distancePoints.length < 2) return;
      
      const totalDistance = calculateTotalDistance();
      const totalKm = (totalDistance / 1000).toFixed(2);
      const totalM = totalDistance.toFixed(2);
      
      // X√≥a label t·ªïng c≈© n·∫øu c√≥
      distanceMarkers.forEach(marker => {
        if (marker.options.icon && marker.options.icon.options.className === 'distance-total') {
          distanceLayer.removeLayer(marker);
        }
      });
      
      // T·∫°o label t·ªïng kho·∫£ng c√°ch ·ªü ƒëi·ªÉm gi·ªØa c·ªßa ƒë∆∞·ªùng
      const midIndex = Math.floor(distancePoints.length / 2);
      const midPoint = distancePoints[midIndex];
      
      const totalLabel = L.marker(midPoint, {
        icon: L.divIcon({
          className: 'distance-total',
          html: `T·ªïng: ${totalM}m (${totalKm}km)`,
          iconSize: [140, 35],
          iconAnchor: [70, 17]
        })
      }).addTo(distanceLayer);
      
      distanceMarkers = [totalLabel]; // Ch·ªâ gi·ªØ 1 label duy nh·∫•t
    }
    
    // H√†m x√≥a ƒëo kho·∫£ng c√°ch
    function clearDistanceMeasure() {
      distanceLayer.clearLayers();
      distancePoints = [];
      distanceLines = [];
      distanceMarkers = [];
      // Tr·∫£ l·∫°i con tr·ªè m·∫∑c ƒë·ªãnh
      try { map.getContainer().style.cursor = ''; } catch(_) {}
    }
    
    // Event listener cho double-click ƒë·ªÉ k·∫øt th√∫c ƒëo kho·∫£ng c√°ch
    map.on('dblclick', function(e) {
      if (distanceMode && distancePoints.length >= 2) {
        distanceMode = false;
        document.getElementById('distanceBtn').classList.remove('active');
        // Tr·∫£ l·∫°i con tr·ªè m·∫∑c ƒë·ªãnh khi k·∫øt th√∫c ƒëo
        try { map.getContainer().style.cursor = ''; } catch(_) {}
        
        // C·∫≠p nh·∫≠t status bar
        const totalDistance = calculateTotalDistance();
        const totalKm = (totalDistance / 1000).toFixed(2);
        const totalM = totalDistance.toFixed(2);
        
        document.getElementById('statusBar').textContent = 
          `Ho√†n th√†nh ƒëo kho·∫£ng c√°ch | T·ªïng: ${totalM}m (${totalKm}km) | C√¢y: ${markers.length}`;
      }
    });

    function countTreesInArea() {
      if (drawnItems.getLayers().length === 0) {
        return;
      }
      
      // L·∫•y v√πng cu·ªëi c√πng ƒë∆∞·ª£c v·∫Ω
      const layers = drawnItems.getLayers();
      const lastLayer = layers[layers.length - 1];
      
      if (!(lastLayer instanceof L.Polygon)) {
        return;
      }
      
      const areaBounds = lastLayer.getBounds();
      
      // ƒê·∫øm c√¢y trong v√πng
      let treesInArea = [];
      let statusCount = {};
      let typeCount = {};
      let diseaseCount = {};
      
      markers.forEach(marker => {
        const latLng = marker.getLatLng();
        if (areaBounds.contains(latLng)) {
          const data = marker.treeData;
          treesInArea.push(data);
          
          // ƒê·∫øm theo ch·∫•t l∆∞·ª£ng
          statusCount[data.chatLuong] = (statusCount[data.chatLuong] || 0) + 1;
          
          // ƒê·∫øm theo lo·∫°i c√¢y
          typeCount[data.ten] = (typeCount[data.ten] || 0) + 1;
          
          // ƒê·∫øm theo t√¨nh tr·∫°ng b·ªánh
          if (data.tinhtrangbenh) {
            diseaseCount[data.tinhtrangbenh] = (diseaseCount[data.tinhtrangbenh] || 0) + 1;
          }
        }
      });
      
      // Hi·ªÉn th·ªã k·∫øt qu·∫£
      showAreaInfo(lastLayer, treesInArea, statusCount, typeCount, diseaseCount);
    }

    function showAreaInfo(layer, treesInArea, statusCount, typeCount, diseaseCount) {
      const areaM2 = layer.areaM2 || 'N/A';
      const areaHa = layer.areaHa || 'N/A';
      const totalTrees = treesInArea.length;
      const density = layer.areaHa ? (totalTrees / layer.areaHa).toFixed(2) : 0;
      
      let html = `
        <h4 style="margin: 0 0 6px 0;">üå≥ Th·ªëng k√™ v√πng ƒë√£ ch·ªçn</h4>
        <p style="margin: 2px 0;"><strong>Di·ªán t√≠ch:</strong> ${areaM2} m¬≤ (${areaHa} ha)</p>
        <p style="margin: 2px 0;"><strong>T·ªïng s·ªë c√¢y:</strong> ${totalTrees}</p>
        <p style="margin: 2px 0 6px 0;"><strong>M·∫≠t ƒë·ªô:</strong> ${density} c√¢y/ha</p>
        
        <h5 style="margin: 4px 0;">üìä Theo ch·∫•t l∆∞·ª£ng:</h5>
      `;
      
      for (let quality in statusCount) {
        const percentage = totalTrees > 0 ? ((statusCount[quality]/totalTrees)*100).toFixed(1) : 0;
        html += `<p style="margin: 2px 0; font-size: 11px;">‚Ä¢ ${quality}: ${statusCount[quality]} (${percentage}%)</p>`;
      }
      
      html += `<h5 style="margin: 6px 0 4px 0;">üå± Top lo·∫°i c√¢y:</h5>`;
      const sortedTypes = Object.entries(typeCount)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
      
      sortedTypes.forEach(([name, count], index) => {
        const percentage = totalTrees > 0 ? ((count/totalTrees)*100).toFixed(1) : 0;
        html += `<p style="margin: 2px 0; font-size: 11px;">${index + 1}. ${name}: ${count} (${percentage}%)</p>`;
      });
      
      // Th√™m th·ªëng k√™ t√¨nh tr·∫°ng b·ªánh
      if (Object.keys(diseaseCount).length > 0) {
        html += `<h5 style="margin: 6px 0 4px 0;">üè• T√¨nh tr·∫°ng b·ªánh:</h5>`;
        Object.entries(diseaseCount)
          .sort(([,a], [,b]) => b - a)
          .forEach(([benh, count]) => {
            const percentage = totalTrees > 0 ? ((count/totalTrees)*100).toFixed(1) : 0;
            html += `<p style="margin: 2px 0; font-size: 11px;">‚Ä¢ ${benh}: ${count} (${percentage}%)</p>`;
          });
      }
      
      html += `<button onclick="closeAreaInfo()" style="margin-top: 8px; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">ƒê√≥ng</button>`;
      
      // T·∫°o popup hi·ªÉn th·ªã th√¥ng tin
      layer.bindPopup(html).openPopup();
    }

    function closeAreaInfo() {
      // ƒê√≥ng popup hi·ªán t·∫°i
      map.closePopup();
    }

    // C·∫≠p nh·∫≠t h√†m updateStats ƒë·ªÉ gi·∫£m font ch·ªØ
    function updateStats(tong, tinhTrangStats, loaiCayStats, colorStats) {
      let html = `<div style="font-weight: bold; color: #2c3e50; margin-bottom: 6px; font-size: 10px;">üå≥ T·ªïng s·ªë c√¢y: ${tong}</div>`;

      html += `<div style="margin-bottom: 6px; font-size: 9px;"><strong>üìå Ch·∫•t l∆∞·ª£ng:</strong></div>`;
      for (let k in tinhTrangStats) {
        const pct = ((tinhTrangStats[k]/tong)*100).toFixed(1);
        html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${k}: ${tinhTrangStats[k]} (${pct}%)</div>`;
      }

      html += `<div style="margin: 6px 0; font-size: 9px;"><strong>üå± Lo·∫°i c√¢y:</strong></div>`;
      for (let k in loaiCayStats) {
        const pct = ((loaiCayStats[k]/tong)*100).toFixed(1);
        html += `<div style="margin-left: 8px; font-size: 8px;">‚Ä¢ ${k}: ${loaiCayStats[k]} (${pct}%)</div>`;
      }

      const statsEl = document.getElementById('stats');
      if (statsEl) {
        statsEl.innerHTML = html;
      }
    }


    // H√†m c·∫≠p nh·∫≠t th√¥ng tin l·ªçc trong legend
    function updateFilterInfo() {
      const filterInfo = document.getElementById('filterInfo');
      if (!filterInfo) return;
      
      const searchTerm = document.getElementById('searchBox').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const yearFilter = document.getElementById('yearFilter').value;
      
      let html = '<h5>üîç ƒêi·ªÅu ki·ªán l·ªçc hi·ªán t·∫°i:</h5>';
      
      if (searchTerm) {
        html += `<div class="filter-item">
          <span class="filter-label">T√¨m ki·∫øm:</span>
          <span class="filter-value">"${searchTerm}"</span>
        </div>`;
      }
      
      if (statusFilter) {
        html += `<div class="filter-item">
          <span class="filter-label">Ch·∫•t l∆∞·ª£ng:</span>
          <span class="filter-value">${statusFilter}</span>
        </div>`;
      }
      
      if (typeFilter) {
        html += `<div class="filter-item">
          <span class="filter-label">Lo·∫°i c√¢y:</span>
          <span class="filter-value">${typeFilter}</span>
        </div>`;
      }
      
      if (yearFilter) {
        html += `<div class="filter-item">
          <span class="filter-label">NƒÉm tr·ªìng:</span>
          <span class="filter-value">${yearFilter}</span>
        </div>`;
      }
      
      if (!searchTerm && !statusFilter && !typeFilter && !yearFilter) {
        html += '<div class="filter-item"><span class="filter-value">Kh√¥ng c√≥ ƒëi·ªÅu ki·ªán l·ªçc</span></div>';
      }
      
      filterInfo.innerHTML = html;
    }

    // H√†m c·∫≠p nh·∫≠t legend v·ªõi th√¥ng tin m√†u s·∫Øc
    function updateLegend() {
      // legend removed
    }

    // H√†m hi·ªÉn th·ªã/·∫©n legend
    function toggleLegend() { /* legend removed */ }

    function showLegend() { /* legend removed */ }

    // function showStatsPanel() { /* removed */ }

    // H√†m ƒëi·ªÅu khi·ªÉn panel b·∫£n ƒë·ªì
    function toggleMapPanel() {
      const panel = document.getElementById('mapPanel');
      const content = panel.querySelector('.map-panel-content');
      const btn = panel.querySelector('.minimize-btn');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '‚àí';
        btn.title = 'Thu g·ªçn';
      } else {
        content.style.display = 'none';
        btn.textContent = '+';
        btn.title = 'M·ªü r·ªông';
      }
    }

    // H√†m ƒëi·ªÅu khi·ªÉn panel th·ªëng k√™
    function toggleStatsPanel() {
      const panel = document.getElementById('statsPanel');
      const content = panel.querySelector('.stats-panel-content');
      const btn = panel.querySelector('.minimize-btn');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.textContent = '‚àí';
        btn.title = 'Thu g·ªçn';
      } else {
        content.style.display = 'none';
        btn.textContent = '+';
        btn.title = 'M·ªü r·ªông';
      }
    }


    function toggleClustering() {
      clusteringEnabled = !clusteringEnabled;
      const btn = document.getElementById('clusterBtn');
      btn.textContent = clusteringEnabled ? 'üìä' : 'üìà';
      btn.title = clusteringEnabled ? 'T·∫Øt clustering' : 'B·∫≠t clustering';
      btn.className = clusteringEnabled ? 'map-tool-btn-small active' : 'map-tool-btn-small';
      updateMarkers();
      console.log(`Clustering ${clusteringEnabled ? 'b·∫≠t' : 't·∫Øt'}`);
    }

    // H√†m k√©o th·∫£ cho legend
    function startDrag(event, elementId) {
      const element = document.getElementById(elementId);
      const rect = element.getBoundingClientRect();
      
      const startX = event.clientX - rect.left;
      const startY = event.clientY - rect.top;
      
      function onMouseMove(e) {
        let newX = e.clientX - startX;
        let newY = e.clientY - startY;
        
        // Gi·ªõi h·∫°n trong viewport
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const elementWidth = rect.width;
        const elementHeight = rect.height;
        
        // Gi·ªõi h·∫°n theo chi·ªÅu ngang
        if (newX < 0) newX = 0;
        if (newX + elementWidth > viewportWidth) newX = viewportWidth - elementWidth;
        
        // Gi·ªõi h·∫°n theo chi·ªÅu d·ªçc
        if (newY < 0) newY = 0;
        if (newY + elementHeight > viewportHeight) newY = viewportHeight - elementHeight;
        
        // Ki·ªÉm tra va ch·∫°m v·ªõi control panel b√™n tr√°i
        const controlPanel = document.querySelector('.control-panel');
        if (controlPanel && controlPanel.style.display !== 'none') {
          const controlRect = controlPanel.getBoundingClientRect();
          const controlLeft = parseFloat(controlPanel.style.left) || controlRect.left;
          const controlTop = parseFloat(controlPanel.style.top) || controlRect.top;
          
          // Tr√°nh va ch·∫°m v·ªõi control panel
          if (newX + elementWidth > controlLeft && newX < controlLeft + controlRect.width &&
              newY + elementHeight > controlTop && newY < controlTop + controlRect.height) {
            // ƒê·∫©y sang ph·∫£i control panel
            newX = controlLeft + controlRect.width + 10;
          }
        }
        
        // Ki·ªÉm tra va ch·∫°m v·ªõi legend panel
        const legendPanel = document.getElementById('legend');
        if (legendPanel && legendPanel.style.display !== 'none') {
          const legendRect = legendPanel.getBoundingClientRect();
          const legendLeft = parseFloat(legendPanel.style.left) || legendRect.left;
          const legendTop = parseFloat(legendPanel.style.top) || legendRect.top;
          
          // Tr√°nh va ch·∫°m v·ªõi legend panel
          if (newX + elementWidth > legendLeft && newX < legendLeft + legendRect.width &&
              newY + elementHeight > legendTop && newY < legendTop + legendRect.height) {
            // ƒê·∫©y xu·ªëng d∆∞·ªõi legend panel
            newY = legendTop + legendRect.height + 10;
          }
        }
        
        // Ki·ªÉm tra va ch·∫°m v·ªõi c√°c panel kh√°c
        if (elementId === 'mapPanel') {
          const statsPanel = document.getElementById('statsPanel');
          if (statsPanel && statsPanel.style.display !== 'none') {
            const statsRect = statsPanel.getBoundingClientRect();
            const statsLeft = parseFloat(statsPanel.style.left) || statsRect.left;
            const statsTop = parseFloat(statsPanel.style.top) || statsRect.top;
            
            // Tr√°nh va ch·∫°m v·ªõi stats panel
            if (newX + elementWidth > statsLeft && newX < statsLeft + statsRect.width &&
                newY + elementHeight > statsTop && newY < statsTop + statsRect.height) {
              // ƒê·∫©y xu·ªëng d∆∞·ªõi stats panel
              newY = statsTop + statsRect.height + 10;
            }
          }
        } else if (elementId === 'statsPanel') {
          const mapPanel = document.getElementById('mapPanel');
          if (mapPanel && mapPanel.style.display !== 'none') {
            const mapRect = mapPanel.getBoundingClientRect();
            const mapLeft = parseFloat(mapPanel.style.left) || mapRect.left;
            const mapTop = parseFloat(mapPanel.style.top) || mapRect.top;
            
            // Tr√°nh va ch·∫°m v·ªõi map panel
            if (newX + elementWidth > mapLeft && newX < mapLeft + mapRect.width &&
                newY + elementHeight > mapTop && newY < mapTop + mapRect.height) {
              // ƒê·∫©y l√™n tr√™n map panel
              newY = mapTop - elementHeight - 10;
              if (newY < 0) newY = 0;
            }
          }
        }
        
        element.style.left = newX + 'px';
        element.style.top = newY + 'px';
        element.style.right = 'auto';
        element.style.bottom = 'auto';
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }

    // H√†m k√©o th·∫£ cho chart
    function startDragChart(event, elementId) {
      startDrag(event, elementId);
    }

    // ===== B·∫¢NG TH√îNG TIN CHI TI·∫æT =====
    
    // Detail table removed
    
    // L·∫•y m√†u s·∫Øc theo tr·∫°ng th√°i
    function getStatusColor(status) {
      const colorMap = {
        'T·ªët': '#27ae60',
        'Trung b√¨nh': '#f39c12', 
        'K√©m': '#e74c3c',
        'Ch·∫øt': '#95a5a6',
        'Kh√¥ng x√°c ƒë·ªãnh': '#6c757d'
      };
      return colorMap[status] || '#6c757d';
    }

    // ===== B·∫¢NG T·ªîNG H·ª¢P =====
    function updateSummaryTable() {
      const panel = document.getElementById('summaryPanel');
      const treeBody = document.getElementById('summaryTreeBody');
      const farmBody = document.getElementById('summaryFarmBody');
      const statusBody = document.getElementById('summaryStatusBody');
      const activeBox = document.getElementById('summaryActiveFilters');
      const activeContent = document.getElementById('summaryActiveContent');

      if (!treeBody || !farmBody || !statusBody) return;

      const visibleMarkers = markers.filter(marker => marker.options.opacity > 0.5);
      
      // Lu√¥n hi·ªÉn th·ªã panel b√™n ph·∫£i, k·ªÉ c·∫£ khi kh√¥ng c√≥ d·ªØ li·ªáu
      panel.style.display = 'block';
      if (visibleMarkers.length === 0) {
        if (treeBody) treeBody.innerHTML = '<tr><td colspan="2">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        if (farmBody) farmBody.innerHTML = '<tr><td colspan="2">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        if (statusBody) statusBody.innerHTML = '<tr><td colspan="2">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        // V·∫´n hi·ªÉn th·ªã ph·∫ßn theo th√¥ng tin l·ªçc n·∫øu c√≥ filter ƒëang b·∫≠t
        const activeFiltersExist = [
          'statusFilter','typeFilter','yearFilter','tenntFilter','tendoiFilter','tendtFilter','tenloFilter','tenttFilter','cnFilter'
        ].some(id => { const el = document.getElementById(id); return el && el.value; });
        const activeBox = document.getElementById('summaryActiveFilters');
        const activeContent = document.getElementById('summaryActiveContent');
        if (activeBox && activeContent) {
          activeBox.style.display = activeFiltersExist ? 'block' : 'none';
          activeContent.innerHTML = activeFiltersExist ? '<div>Kh√¥ng c√≥ d·ªØ li·ªáu theo b·ªô l·ªçc</div>' : '';
        }
        return;
      }
      
      const loaiCayTotals = {};
      const farmTotals = {}; // g·ªôp theo chu·ªói "tennt / tendoi / tenlo"
      const yearTotals = {};
      const qualityTotals = {};
      const diseaseTotals = {};

      visibleMarkers.forEach(marker => {
        const d = marker.treeData || {};
        if (d.ten || d.loaiCay) {
          const key = d.ten || d.loaiCay;
          loaiCayTotals[key] = (loaiCayTotals[key] || 0) + 1;
        }
        const farmKey = [d.tennt, d.tendoi || d.tengd, d.tenlo].filter(Boolean).join(' / ') || 'N/A';
        farmTotals[farmKey] = (farmTotals[farmKey] || 0) + 1;
        if (d.namTrong) yearTotals[d.namTrong] = (yearTotals[d.namTrong] || 0) + 1;
        if (d.chatLuong) qualityTotals[d.chatLuong] = (qualityTotals[d.chatLuong] || 0) + 1;
        if (d.tinhtrangbenh) diseaseTotals[d.tinhtrangbenh] = (diseaseTotals[d.tinhtrangbenh] || 0) + 1;
      });

      const renderRows = (obj) => Object.entries(obj)
        .sort((a,b) => b[1]-a[1])
        .map(([k,v]) => `<tr><td>${k}</td><td style=\"text-align:right;\"><strong>${v}</strong></td></tr>`)
        .join('');

      // summary removed

      // Hi·ªÉn th·ªã nh√≥m theo th√¥ng tin l·ªçc ƒëang b·∫≠t
      const filters = [];

      const activeFilters = filters.filter(f => {
        const el = document.getElementById(f.id);
        return el && el.value;
      });

      activeBox.style.display = 'none';
      activeContent.innerHTML = '';
    }

    // T√≠nh v√† c·∫≠p nh·∫≠t th·ªëng k√™ theo b·ªô l·ªçc hi·ªán t·∫°i
    function updateFilterStatsPanel() {
      const body = document.getElementById('filterStatsBody');
      if (!body) return;

      const getVal = (id) => {
        const el = document.getElementById(id);
        return el && typeof el.value !== 'undefined' ? el.value : '';
      };

      const f = {
        status: getVal('statusFilter'),
        type: getVal('typeFilter'),
        year: getVal('yearFilter'),
        tennt: getVal('tenntFilter'),
        tendoi: getVal('tendoiFilter'),
        tendt: getVal('tendtFilter'),
        tenlo: getVal('tenloFilter'),
        tentt: getVal('tenttFilter'),
        cn: getVal('cnFilter')
      };

      const hasAnyFilter = Object.values(f).some(v => v && v !== '');

      const filtered = markers.filter(m => {
        const d = m.treeData || {};
        if (f.status && d.chatLuong !== f.status) return false;
        if (f.type && (d.ten || d.loaiCay) !== f.type) return false;
        if (f.year && (!d.namTrong || parseInt(d.namTrong) !== parseInt(f.year))) return false;
        if (f.tennt && d.tennt !== f.tennt) return false;
        if (f.tendoi && (d.tendoi || d.tengd) !== f.tendoi) return false;
        if (f.tendt && d.tendt !== f.tendt) return false;
        if (f.tenlo && d.tenlo !== f.tenlo) return false;
        if (f.tentt && d.tentt !== f.tentt) return false;
        if (f.cn && d.cn !== f.cn) return false;
        return true;
      });

      const source = hasAnyFilter ? filtered : markers;

      const counts = {
        'T·ªïng s·ªë c√¢y': source.length,
        'Theo ch·∫•t l∆∞·ª£ng': {},
        'Theo t√™n c√¢y': {},
        'Theo nƒÉm tr·ªìng': {},
        'Theo n√¥ng tr∆∞·ªùng/ƒë·ªôi/l√¥': {}
      };

      source.forEach(m => {
        const d = m.treeData || {};
        if (d.chatLuong) counts['Theo ch·∫•t l∆∞·ª£ng'][d.chatLuong] = (counts['Theo ch·∫•t l∆∞·ª£ng'][d.chatLuong] || 0) + 1;
        const loai = d.ten || d.loaiCay; if (loai) counts['Theo t√™n c√¢y'][loai] = (counts['Theo t√™n c√¢y'][loai] || 0) + 1;
        if (d.namTrong) counts['Theo nƒÉm tr·ªìng'][d.namTrong] = (counts['Theo nƒÉm tr·ªìng'][d.namTrong] || 0) + 1;
        const farmKey = [d.tennt, d.tendoi || d.tengd, d.tenlo].filter(Boolean).join(' / ');
        if (farmKey) counts['Theo n√¥ng tr∆∞·ªùng/ƒë·ªôi/l√¥'][farmKey] = (counts['Theo n√¥ng tr∆∞·ªùng/ƒë·ªôi/l√¥'][farmKey] || 0) + 1;
      });

      const renderGroup = (title, obj) => {
        if (typeof obj === 'number') return `<tr><td>${title}</td><td><strong>${obj}</strong></td></tr>`;
        const rows = Object.entries(obj)
          .sort((a,b)=>b[1]-a[1])
          .map(([k,v]) => `<tr><td>${title} - ${k}</td><td style=\"text-align:right;\"><strong>${v}</strong></td></tr>`)
          .join('');
        return rows || `<tr><td>${title}</td><td>0</td></tr>`;
      };

      body.innerHTML = [
        renderGroup('T·ªïng s·ªë c√¢y', counts['T·ªïng s·ªë c√¢y']),
        renderGroup('Theo ch·∫•t l∆∞·ª£ng', counts['Theo ch·∫•t l∆∞·ª£ng']),
        renderGroup('Theo t√™n c√¢y', counts['Theo t√™n c√¢y']),
        renderGroup('Theo nƒÉm tr·ªìng', counts['Theo nƒÉm tr·ªìng']),
        renderGroup('Theo n√¥ng tr∆∞·ªùng/ƒë·ªôi/l√¥', counts['Theo n√¥ng tr∆∞·ªùng/ƒë·ªôi/l√¥'])
      ].join('');

      const totalEl = document.getElementById('filterStatsTotal');
      if (totalEl) totalEl.textContent = `| T·ªïng: ${source.length}`;
    }

    // Panel th·ªëng k√™ khi nh·∫≠p file
    // removed import stats panel init



  </script>
</body>
</html>

